<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyBlock Mobile RPG</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- –î–æ–±–∞–≤–ª—è–µ–º Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #0b0b0d; --card: #16161a; --accent: #ffaa00;
            --blue: #5555ff; --red: #ff5555; --gray: #aaaaaa; --white: #ffffff;
            --green: #55ff55; --dark-gray: #333333;
        }
        body {
            margin: 0; padding: 0; background: var(--bg); color: var(--white);
            font-family: 'Courier New', Courier, monospace;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        #header-ui {
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.8); border-bottom: 2px solid var(--dark-gray);
        }
        .sb-lvl-badge { color: var(--accent); font-weight: bold; border: 1px solid var(--accent); padding: 4px 8px; border-radius: 4px; font-size: 0.9rem; }
        .top-btn { background: var(--dark-gray); border: 1px solid #555; color: white; padding: 6px 10px; border-radius: 4px; font-size: 0.75rem; }
        #viewport { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        .screen { display: none; }
        .screen.active { display: block; }
        .card { background: var(--card); border: 2px solid var(--dark-gray); padding: 15px; margin-bottom: 12px; border-radius: 8px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem; }
        .stat-label { color: var(--gray); }
        .stat-val { color: var(--red); font-weight: bold; }
        .cooldown-btn {
            position: relative; width: 100%; height: 55px; background: #222; border: 2px solid #444;
            color: white; font-weight: bold; cursor: pointer; overflow: hidden; margin-top: 5px; border-radius: 8px;
        }
        .progress-overlay { position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: rgba(255, 170, 0, 0.3); }
        .portal-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .portal-node { background: #222; border: 2px solid #444; padding: 15px; text-align: center; font-size: 0.9rem; cursor: pointer; border-radius: 8px; }
        #nav {
            position: fixed; bottom: 0; width: 100%; height: 70px;
            background: #1c1c1c; display: flex; border-top: 3px solid var(--dark-gray);
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #777; font-size: 0.7rem; background: none; border: none; text-transform: uppercase; font-weight: bold;
        }
        .nav-item.active { color: var(--accent); background: #252525; }
        .nav-item span { font-size: 1.4rem; margin-bottom: 2px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; padding: 20px; overflow-y: auto; }
        .hp-bar { width: 100%; height: 12px; background: #333; border: 1px solid #555; margin: 8px 0; border-radius: 6px; overflow: hidden; }
        .hp-fill { height: 100%; background: var(--red); transition: width 0.2s; }
        .inv-tabs { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; }
        .inv-tab { background: #222; border: 1px solid #444; color: #888; padding: 6px 12px; font-size: 0.7rem; white-space: nowrap; border-radius: 4px; }
        .inv-tab.active { border-color: var(--accent); color: var(--white); }
        .item-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 8px; }
        .act-btn { background: #333; border: 1px solid #555; color: white; padding: 4px; font-size: 0.65rem; border-radius: 4px; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .sync-status {
            position: fixed; top: 10px; right: 10px; background: var(--dark-gray);
            padding: 4px 8px; border-radius: 4px; font-size: 0.7rem;
            color: var(--green); display: none;
        }
    </style>
</head>
<body>
    <div id="sync-status" class="sync-status">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</div>
    
    <div id="loading" class="loading-overlay">
        <h2 style="color: var(--accent);">SkyBlock RPG</h2>
        <p id="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        <div style="width: 200px; height: 4px; background: #333; margin-top: 20px; border-radius: 2px; overflow: hidden;">
            <div id="loading-bar" style="width: 0%; height: 100%; background: var(--accent); transition: width 0.3s;"></div>
        </div>
    </div>

    <div id="header-ui">
        <button class="top-btn" onclick="game.showModal('skillsModal')">‚öôÔ∏è –°–ö–ò–õ–õ–´</button>
        <div class="sb-lvl-badge">LVL <span id="sb-lvl">0.00</span></div>
        <button class="top-btn" onclick="game.showModal('leadModal')">üèÜ –¢–û–ü</button>
    </div>
    
    <div id="viewport">
        <div id="home" class="screen active">
            <div class="card" style="text-align: center;">
                <h1 style="margin:0; color:var(--accent);">üí∞ <span id="coins-val">0</span></h1>
                <small style="color:var(--gray)">–¢–í–û–ò –ú–û–ù–ï–¢–´</small>
            </div>
            <div class="card">
                <div class="stat-grid" id="stats-display"></div>
            </div>
        </div>
        
        <div id="portal" class="screen">
            <h3 style="text-align:center; margin-top:0;">üåÄ –ü–û–†–¢–ê–õ</h3>
            <div class="portal-grid">
                <div class="portal-node" onclick="game.goLoc('mine')">‚õèÔ∏è –®–ê–•–¢–ê</div>
                <div class="portal-node" onclick="game.goLoc('farm')">üåæ –§–ï–†–ú–ê</div>
                <div class="portal-node" onclick="game.goLoc('fish')">üé£ –†–´–ë–ê–õ–ö–ê</div>
                <div class="portal-node" onclick="game.switchTab('dungeons-menu')">üíÄ –î–ê–ù–ñ–ò</div>
                <div class="portal-node" onclick="game.msg('–°–∫–æ—Ä–æ...')">üëπ –°–õ–ï–ô–ï–†–´</div>
                <div class="portal-node" onclick="game.msg('–°–∫–æ—Ä–æ...')">üõí –ú–ê–ì–ê–ó–ò–ù</div>
                <div class="portal-node" onclick="game.msg('–°–∫–æ—Ä–æ...')">‚öñÔ∏è –û–ë–ú–ï–ù</div>
                <div class="portal-node" onclick="game.msg('–°–∫–æ—Ä–æ...')">üìÖ –ò–í–ï–ù–¢</div>
                <div class="portal-node" onclick="game.msg('–°–∫–æ—Ä–æ...')">üó≥Ô∏è –ú–≠–†</div>
            </div>
        </div>
        
        <div id="action-loc" class="screen">
            <button class="top-btn" onclick="game.switchTab('portal')">‚Üê –ù–ê–ó–ê–î</button>
            <h2 id="loc-title" style="text-align:center; text-transform:uppercase;">–®–ê–•–¢–ê</h2>
            <div class="card" style="text-align:center">
                <button id="action-btn" class="cooldown-btn" onclick="game.executeAction()">
                    <div id="action-prog" class="progress-overlay"></div>
                    <span style="position:relative">–†–ê–ë–û–¢–ê–¢–¨</span>
                </button>
            </div>
            <div id="loc-log" style="text-align:center; color:var(--green); min-height: 20px; margin-top:10px;"></div>
        </div>
        
        <div id="dungeons-menu" class="screen">
            <button class="top-btn" onclick="game.switchTab('portal')">‚Üê –ù–ê–ó–ê–î</button>
            <h3>üíÄ –ö–ê–¢–ê–ö–û–ú–ë–´</h3>
            <div class="card">
                <p>–≠–¢–ê–ñ I - –í–•–û–î</p>
                <button class="cooldown-btn" onclick="game.startDungeon()">–í–û–ô–¢–ò –í –î–ê–ù–ñ</button>
            </div>
        </div>
        
        <div id="battle-screen" class="screen">
            <h2 id="mob-name" style="text-align:center; color:var(--red);">–ú–û–ù–°–¢–†</h2>
            <div class="card">
                <div style="display:flex; justify-content:space-between"><span>–•–ü –í–†–ê–ì–ê</span><span id="m-hp-txt">50/50</span></div>
                <div class="hp-bar"><div id="m-hp-fill" class="hp-fill" style="width:100%"></div></div>
            </div>
            <div class="card" style="border-color:var(--blue)">
                <div style="display:flex; justify-content:space-between"><span>–¢–í–û–Å –•–ü</span><span id="p-hp-txt">100/100</span></div>
                <div class="hp-bar"><div id="p-hp-fill" class="hp-fill" style="width:100%; background:var(--blue)"></div></div>
            </div>
            <button class="cooldown-btn" style="height:80px" onclick="game.dungeonAttack()">üí• –£–î–ê–†–ò–¢–¨</button>
        </div>
        
        <div id="loot-screen" class="screen">
            <h2 style="text-align:center; color:var(--accent);">–ü–û–ë–ï–î–ê!</h2>
            <p style="text-align:center; font-size:1.2rem;">üéÅ –î–µ—Ä–µ–≤—è–Ω–Ω—ã–π —Å—É–Ω–¥—É–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!</p>
            <button class="cooldown-btn" onclick="game.switchTab('portal')">–í–ï–†–ù–£–¢–¨–°–Ø –ù–ê –ü–û–†–¢–ê–õ</button>
        </div>
        
        <div id="minions" class="screen">
            <div class="card" style="border-color:var(--accent); text-align:center">
                –ö–û–®–ï–õ–ï–ö: <span id="m-coins-val" style="color:var(--accent)">0</span> üí∞
            </div>
            <div id="minions-list"></div>
        </div>
        
        <div id="inventory" class="screen">
            <div class="inv-tabs">
                <div class="inv-tab active" onclick="game.filterInv('weapon', this)">–û–†–£–ñ–ò–ï</div>
                <div class="inv-tab" onclick="game.filterInv('armor', this)">–ë–†–û–ù–Ø</div>
                <div class="inv-tab" onclick="game.filterInv('tool', this)">–ò–ù–°–¢–†–£–ú–ï–ù–¢–´</div>
                <div class="inv-tab" onclick="game.filterInv('material', this)">–ú–ê–¢–ï–†–ò–ê–õ</div>
                <div class="inv-tab" onclick="game.filterInv('arrow', this)">–°–¢–†–ï–õ–´</div>
                <div class="inv-tab" onclick="game.filterInv('potion', this)">–ó–ï–õ–¨–Ø</div>
                <div class="inv-tab" onclick="game.filterInv('chest', this)">–°–£–ù–î–£–ö–ò</div>
            </div>
            <div id="inv-list"></div>
        </div>
    </div>

    <div id="skillsModal" class="modal">
        <span style="float:right; font-weight:bold; cursor:pointer" onclick="game.closeModal('skillsModal')">[–ó–ê–ö–†–´–¢–¨]</span>
        <h3>üìä –¢–í–û–ò –ù–ê–í–´–ö–ò</h3>
        <div id="skills-content"></div>
    </div>
    
    <div id="leadModal" class="modal">
        <span style="float:right; font-weight:bold; cursor:pointer" onclick="game.closeModal('leadModal')">[–ó–ê–ö–†–´–¢–¨]</span>
        <h3>üèÜ –¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</h3>
        <div class="inv-tabs">
            <div class="inv-tab active" id="l-tab-coins" onclick="game.switchLead('coins')">–ü–û –ú–û–ù–ï–¢–ê–ú</div>
            <div class="inv-tab" id="l-tab-lvl" onclick="game.switchLead('lvl')">–ü–û –£–†–û–í–ù–Æ</div>
        </div>
        <div id="lead-list"></div>
    </div>

    <nav id="nav">
        <button class="nav-item active" onclick="game.switchTab('home', this)"><span>üè†</span>–î–û–ú</button>
        <button class="nav-item" onclick="game.switchTab('portal', this)"><span>üåÄ</span>–ü–û–†–¢–ê–õ</button>
        <button class="nav-item" onclick="game.switchTab('minions', this)"><span>üë∑</span>–ú–ò–ù–¨–û–ù–´</button>
        <button class="nav-item" onclick="game.switchTab('inventory', this)"><span>üéí</span>–ò–ù–í–ï–ù–¢–ê–†–¨</button>
    </nav>

    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø SUPABASE ====================
        const SUPABASE_URL = 'https://acddabgvsbqmaqfvjfst.supabase.co';
        // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô –ö–õ–Æ–ß –∏–∑ Supabase ‚Üí Settings ‚Üí API ‚Üí anon public key
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjZGRhYmd2c2JxbWFxZnZqZnN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg2MDA0NjQsImV4cCI6MjA1NDE3NjQ2NH0.bARm_-H7XoEGs8q8jXWTVt6L1XYdQX4-tP9xOft5uPg';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const tg = window.Telegram.WebApp;
        const SAVE_KEY = 'skyblock_save_v4';
        
        const defaultState = {
            coins: 0,
            nextItemId: 10,
            skills: {
                mining: { lvl: 1, xp: 0, next: 100, label: '–®–ê–•–¢–ê' },
                farming: { lvl: 1, xp: 0, next: 100, label: '–§–ï–†–ú–ê' },
                fishing: { lvl: 1, xp: 0, next: 100, label: '–†–´–ë–ê–õ–ö–ê' },
                combat: { lvl: 1, xp: 0, next: 100, label: '–ë–û–ô' },
                foraging: { lvl: 1, xp: 0, next: 100, label: '–õ–ï–°' }
            },
            stats: { hp: 100, str: 10, def: 0, cc: 5, cd: 50, mf: 0, max_hp: 100 },
            inventory: [
                { id: 1, name: '–°—Ç–∞—Ä—ã–π –º–µ—á', type: 'weapon', str: 15, equipped: false },
                { id: 2, name: '–ù–∞—á–∞–ª—å–Ω–∞—è –∫–∏—Ä–∫–∞', type: 'tool', equipped: true },
                { id: 3, name: '–ó–µ–ª—å–µ –ª–µ—á–µ–Ω–∏—è', type: 'potion' }
            ],
            minions: [
                { id: 'wheat', name: '–ü–®–ï–ù–ò–ß–ù–´–ô', cost: 50, count: 0, stored: 0, rate: 0.5 },
                { id: 'fish', name: '–†–´–ë–ù–´–ô', cost: 75, count: 0, stored: 0, rate: 0.75 },
                { id: 'oak', name: '–î–£–ë–û–í–´–ô', cost: 100, count: 0, stored: 0, rate: 1.0 },
                { id: 'coal', name: '–£–ì–û–õ–¨–ù–´–ô', cost: 125, count: 0, stored: 0, rate: 1.5 }
            ]
        };

        const game = {
            state: { ...defaultState },
            dungeon: { mobIdx: 0, mobHp: 50, pHp: 100, pMaxHp: 100, mobs: ['–ó–û–ú–ë–ò', '–°–ö–ï–õ–ï–¢', '–ü–ê–£–ö', '–ë–û–°–°'] },
            isBusy: false,
            currentLoc: '',
            lastFilter: 'weapon',
            lastCloudSave: 0,
            isOnline: false,
            
            // ==================== SUPABASE –§–£–ù–ö–¶–ò–ò ====================
            async initializePlayer() {
                const userId = tg.initDataUnsafe?.user?.id;
                const username = tg.initDataUnsafe?.user?.username || 'Player';
                
                if (!userId) {
                    console.log('–ù–µ—Ç Telegram ID, —Ä–∞–±–æ—Ç–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω');
                    return false;
                }
                
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–≥—Ä–æ–∫ –≤ –±–∞–∑–µ
                    const { data, error } = await supabase
                        .from('players')
                        .select('*')
                        .eq('user_id', userId)
                        .single();
                    
                    if (error && error.code !== 'PGRST116') { // PGRST116 = –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                        throw error;
                    }
                    
                    if (data) {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –±–∞–∑—ã
                        this.state.coins = data.coins || 0;
                        
                        if (data.data) {
                            this.state.skills = data.data.skills || this.state.skills;
                            this.state.stats = data.data.stats || this.state.stats;
                            this.state.inventory = data.data.inventory || this.state.inventory;
                            this.state.minions = data.data.minions || this.state.minions;
                            this.state.nextItemId = data.data.nextItemId || this.state.nextItemId;
                        }
                        
                        console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞');
                        this.isOnline = true;
                        return true;
                    } else {
                        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                        const saveData = {
                            user_id: userId,
                            name: '@' + username,
                            coins: 0,
                            total_level: 1,
                            data: {
                                stats: this.state.stats,
                                skills: this.state.skills,
                                inventory: this.state.inventory,
                                minions: this.state.minions,
                                nextItemId: this.state.nextItemId,
                                created_at: new Date().toISOString()
                            }
                        };
                        
                        const { error: insertError } = await supabase
                            .from('players')
                            .insert(saveData);
                        
                        if (insertError) throw insertError;
                        
                        console.log('–ù–æ–≤—ã–π –∏–≥—Ä–æ–∫ —Å–æ–∑–¥–∞–Ω –≤ –æ–±–ª–∞–∫–µ');
                        this.isOnline = true;
                        return true;
                    }
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ Supabase:', err);
                    this.isOnline = false;
                    return false;
                }
            },
            
            async saveToCloud() {
                if (!this.isOnline || !tg.initDataUnsafe?.user?.id) return;
                
                const userId = tg.initDataUnsafe.user.id;
                const username = tg.initDataUnsafe.user.username || 'Player';
                const totalLevel = Object.values(this.state.skills)
                    .reduce((sum, skill) => sum + skill.lvl, 0) - 5;
                
                const saveData = {
                    user_id: userId,
                    name: '@' + username,
                    coins: this.state.coins,
                    total_level: Math.max(1, Math.floor(totalLevel / 10)),
                    data: {
                        stats: this.state.stats,
                        skills: this.state.skills,
                        inventory: this.state.inventory,
                        minions: this.state.minions,
                        nextItemId: this.state.nextItemId,
                        last_save: new Date().toISOString()
                    }
                };
                
                try {
                    document.getElementById('sync-status').style.display = 'block';
                    
                    const { error } = await supabase
                        .from('players')
                        .upsert(saveData, { onConflict: 'user_id' });
                    
                    if (error) throw error;
                    
                    document.getElementById('sync-status').style.color = 'var(--green)';
                    document.getElementById('sync-status').textContent = '‚úì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ';
                    
                    setTimeout(() => {
                        document.getElementById('sync-status').style.display = 'none';
                    }, 2000);
                    
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ:', err);
                    document.getElementById('sync-status').style.color = 'var(--red)';
                    document.getElementById('sync-status').textContent = '‚úó –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏';
                    this.isOnline = false;
                }
            },
            
            async getLeaderboard(type = 'coins') {
                try {
                    const { data, error } = await supabase
                        .from('players')
                        .select('name, coins, total_level')
                        .order(type === 'coins' ? 'coins' : 'total_level', { ascending: false })
                        .limit(20);
                    
                    if (error) throw error;
                    
                    return data.map((player, index) => ({
                        rank: index + 1,
                        name: player.name || '@Player',
                        value: type === 'coins' 
                            ? `${Math.floor(player.coins).toLocaleString()} üí∞`
                            : `LVL ${player.total_level}`
                    }));
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞:', err);
                    return [];
                }
            },
            
            // ==================== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
            async load() {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                document.getElementById('loading').style.display = 'flex';
                document.getElementById('loading-bar').style.width = '30%';
                document.getElementById('loading-text').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...';
                
                // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage
                const saved = localStorage.getItem(SAVE_KEY);
                if (saved) {
                    try {
                        this.state = JSON.parse(saved);
                        console.log("–õ–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω");
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö", e);
                        this.state = { ...defaultState };
                    }
                }
                
                // 2. –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞
                document.getElementById('loading-bar').style.width = '60%';
                document.getElementById('loading-text').textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–±–ª–∞–∫–æ–º...';
                
                if (tg.initDataUnsafe?.user?.id) {
                    await this.initializePlayer();
                }
                
                // 3. –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                document.getElementById('loading-bar').style.width = '100%';
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    this.updateUI();
                }, 500);
            },

            save() {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                localStorage.setItem(SAVE_KEY, JSON.stringify(this.state));
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±–ª–∞–∫–æ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                if (!this.lastCloudSave || Date.now() - this.lastCloudSave > 30000) {
                    this.saveToCloud();
                    this.lastCloudSave = Date.now();
                }
            },

            async init() {
                tg.expand();
                await this.load();
                setInterval(() => this.minionTick(), 1000);
                setInterval(() => this.save(), 5000); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫
            },

            addMaterial(name, type = 'material') {
                const existing = this.state.inventory.find(i => i.name === name && i.type === type);
                if (existing) {
                    existing.count = (existing.count || 1) + 1;
                } else {
                    this.state.inventory.push({
                        id: this.state.nextItemId++,
                        name: name,
                        type: type,
                        count: 1
                    });
                }
            },

            calcStats() {
                let s = { ...this.state.stats };
                this.state.inventory.forEach(i => {
                    if (i.equipped && i.str) s.str += i.str;
                    if (i.equipped && i.def) s.def += i.def;
                });
                return s;
            },

            updateUI() {
                const s = this.calcStats();
                document.getElementById('coins-val').innerText = Math.floor(this.state.coins).toLocaleString();
                document.getElementById('m-coins-val').innerText = Math.floor(this.state.coins).toLocaleString();

                const totalLvl = Object.values(this.state.skills).reduce((a, b) => a + b.lvl, 0) - 5;
                document.getElementById('sb-lvl').innerText = (totalLvl / 10).toFixed(2);

                document.getElementById('stats-display').innerHTML = `
                    <div><span class="stat-label">‚ù§Ô∏è –ó–î–û–†–û–í–¨–ï:</span> <span class="stat-val">${s.hp}/${s.max_hp}</span></div>
                    <div><span class="stat-label">‚öîÔ∏è –°–ò–õ–ê:</span> <span class="stat-val">${s.str}</span></div>
                    <div><span class="stat-label">üõ°Ô∏è –ë–†–û–ù–Ø:</span> <span class="stat-val">${s.def}</span></div>
                    <div><span class="stat-label">üí• –ö–†–ò–¢ –®–ê–ù–°:</span> <span class="stat-val">${s.cc}%</span></div>
                    <div><span class="stat-label">üî• –ö–†–ò–¢ –£–†–û–ù:</span> <span class="stat-val">${s.cd}%</span></div>
                    <div><span class="stat-label">üçÄ –£–î–ê–ß–ê:</span> <span class="stat-val">${s.mf}</span></div>
                `;

                this.renderMinions();
                this.renderInvList(this.lastFilter);
                this.save(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ UI
            },

            goLoc(loc) {
                this.currentLoc = loc;
                this.switchTab('action-loc');
                const titles = { mine: '–®–ê–•–¢–ê', farm: '–§–ï–†–ú–ê', fish: '–†–´–ë–ê–õ–ö–ê' };
                document.getElementById('loc-title').innerText = titles[loc] || '–õ–û–ö–ê–¶–ò–Ø';
                document.getElementById('loc-log').innerText = '';
            },

            executeAction() {
                if (this.isBusy) return;
                this.isBusy = true;
                const prog = document.getElementById('action-prog');
                const btn = document.getElementById('action-btn');
                btn.disabled = true;
                prog.style.width = '0%';
                setTimeout(() => {
                    prog.style.transition = 'width 1.5s linear';
                    prog.style.width = '100%';
                }, 20);
                setTimeout(() => {
                    this.isBusy = false;
                    btn.disabled = false;
                    prog.style.transition = 'none';
                    prog.style.width = '0%';
                    this.finishAction();
                }, 1520);
            },

            finishAction() {
                const map = { mine: 'mining', farm: 'farming', fish: 'fishing' };
                const skill = this.state.skills[map[this.currentLoc]];
                const gain = 15 * skill.lvl;
                this.state.coins += gain;
                skill.xp += 20;
                if (skill.xp >= skill.next) {
                    skill.lvl++;
                    skill.xp = 0;
                    skill.next = Math.floor(skill.next * 1.6);
                    this.msg(`üéâ LEVEL UP! ${skill.label} —Ç–µ–ø–µ—Ä—å ${skill.lvl} —É—Ä–æ–≤–µ–Ω—å!`);
                }

                const materials = { mine: '–£–≥–æ–ª—å', farm: '–ü—à–µ–Ω–∏—Ü–∞', fish: '–†—ã–±–∞' };
                const matName = materials[this.currentLoc];
                this.addMaterial(matName);

                document.getElementById('loc-log').innerText = `+${gain} üí∞ | +20 XP | +1 ${matName}`;
                this.updateUI();
                tg.HapticFeedback.impactOccurred('light');
            },

            startDungeon() {
                const s = this.calcStats();
                this.dungeon = {
                    mobIdx: 0,
                    mobHp: 50,
                    pHp: s.hp,
                    pMaxHp: s.hp,
                    mobs: ['–ó–û–ú–ë–ò', '–°–ö–ï–õ–ï–¢', '–ü–ê–£–ö', '–ë–û–°–°']
                };
                this.updateBattleUI();
                this.switchTab('battle-screen');
            },

            dungeonAttack() {
                const s = this.calcStats();
                let dmg = s.str;
                if (Math.random() * 100 < s.cc) {
                    dmg = Math.floor(dmg * (1 + s.cd / 100));
                    this.msg("üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–î–ê–†!");
                }
                this.dungeon.mobHp -= dmg;

                const enemyDmg = this.dungeon.mobIdx === 3 ? 6 : 4;
                this.dungeon.pHp -= Math.max(1, enemyDmg - s.def);

                if (this.dungeon.mobHp <= 0) {
                    this.dungeon.mobIdx++;
                    if (this.dungeon.mobIdx >= this.dungeon.mobs.length) {
                        this.giveDungeonReward();
                        this.switchTab('loot-screen');
                    } else {
                        this.dungeon.mobHp = this.dungeon.mobIdx === 3 ? 80 : 50;
                        this.dungeon.pHp = Math.min(this.dungeon.pMaxHp, this.dungeon.pHp + this.dungeon.pMaxHp * 0.2);
                        this.msg("üéØ –ú–û–ë –£–ë–ò–¢! +20% –•–ü");
                        this.updateBattleUI();
                    }
                }

                if (this.dungeon.pHp <= 0) {
                    this.msg("‚ò†Ô∏è –¢–´ –£–ú–ï–†!");
                    this.switchTab('portal');
                } else {
                    this.updateBattleUI();
                }
                tg.HapticFeedback.impactOccurred('medium');
            },

            giveDungeonReward() {
                this.state.coins += 150;
                this.state.skills.combat.xp += 50;
                if (this.state.skills.combat.xp >= this.state.skills.combat.next) {
                    this.state.skills.combat.lvl++;
                    this.state.skills.combat.xp = 0;
                    this.state.skills.combat.next = Math.floor(this.state.skills.combat.next * 1.6);
                    this.msg("üéñÔ∏è –ë–û–ï–í–û–ô –£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù!");
                }
                this.addMaterial('–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π —Å—É–Ω–¥—É–∫', 'chest');
                this.updateUI();
            },

            updateBattleUI() {
                document.getElementById('mob-name').innerText = this.dungeon.mobs[this.dungeon.mobIdx] || '???';
                const maxMobHp = this.dungeon.mobIdx === 3 ? 80 : 50;
                document.getElementById('m-hp-txt').innerText = `${Math.max(0, Math.floor(this.dungeon.mobHp))}/${maxMobHp}`;
                document.getElementById('m-hp-fill').style.width = Math.max(0, this.dungeon.mobHp / maxMobHp * 100) + '%';
                document.getElementById('p-hp-txt').innerText = `${Math.max(0, Math.floor(this.dungeon.pHp))}/${this.dungeon.pMaxHp}`;
                document.getElementById('p-hp-fill').style.width = (this.dungeon.pHp / this.dungeon.pMaxHp * 100) + '%';
            },

            renderMinions() {
                const list = document.getElementById('minions-list');
                list.innerHTML = '';
                this.state.minions.forEach((m, i) => {
                    const canBuy = this.state.coins >= m.cost && m.count < 13;
                    const canCollect = m.stored >= 0.1;
                    list.innerHTML += `
                        <div class="card">
                            <div style="display:flex; justify-content:space-between">
                                <b>${m.name} (${m.count}/13)</b>
                                <span>üì¶ ${m.stored.toFixed(1)}/64</span>
                            </div>
                            <div class="item-actions">
                                <button class="act-btn" ${!canBuy ? 'disabled' : ''} onclick="game.buyMinion(${i})">
                                    –ö–£–ü–ò–¢–¨ (${Math.floor(m.cost)}üí∞)
                                </button>
                                <button class="act-btn" ${!canCollect ? 'disabled' : ''} onclick="game.collectMinion(${i})">
                                    –°–û–ë–†–ê–¢–¨ (${Math.floor(m.stored * 20)}üí∞)
                                </button>
                            </div>
                        </div>`;
                });
            },

            buyMinion(i) {
                const m = this.state.minions[i];
                if (this.state.coins >= m.cost && m.count < 13) {
                    this.state.coins -= m.cost;
                    m.count++;
                    m.cost = Math.floor(m.cost * 1.5);
                    m.rate *= 1.2;
                    this.updateUI();
                    this.msg("üë∑ –ú–∏–Ω—å–æ–Ω —É–ª—É—á—à–µ–Ω!");
                }
            },

            collectMinion(i) {
                const m = this.state.minions[i];
                if (m.stored >= 0.1) {
                    const coinsGain = Math.floor(m.stored * 20);
                    this.state.coins += coinsGain;
                    m.stored = 0;
                    this.updateUI();
                    this.msg(`üí∞ +${coinsGain} –æ—Ç –º–∏–Ω—å–æ–Ω–∞!`);
                }
            },

            minionTick() {
                let updated = false;
                this.state.minions.forEach(m => {
                    if (m.count > 0) {
                        const old = m.stored;
                        m.stored = Math.min(64, m.stored + m.rate * m.count / 30);
                        if (Math.floor(m.stored * 10) > Math.floor(old * 10)) updated = true;
                    }
                });
                if (document.querySelector('#minions.active') || updated) {
                    this.renderMinions();
                    document.getElementById('m-coins-val').innerText = Math.floor(this.state.coins).toLocaleString();
                }
            },

            filterInv(type, el) {
                document.querySelectorAll('.inv-tab').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
                this.lastFilter = type;
                this.renderInvList(type);
            },

            renderInvList(type) {
                const list = document.getElementById('inv-list');
                list.innerHTML = '';
                const items = this.state.inventory.filter(i => i.type === type);
                if (items.length === 0) {
                    list.innerHTML = '<div class="card" style="text-align:center; color:#666;">–ü—É—Å—Ç–æ</div>';
                    return;
                }
                items.forEach(item => {
                    const countText = item.count > 1 ? ` (${item.count})` : '';
                    let actions = '';
                    if (item.type === 'material') {
                        actions = `<button class="act-btn" onclick="game.sellItem(${item.id})">–ü–†–û–î–ê–¢–¨</button>`;
                    } else if (item.type === 'chest') {
                        actions = `<button class="act-btn" onclick="game.openChest(${item.id})">–û–¢–ö–†–´–¢–¨</button>`;
                    } else if (['weapon', 'tool', 'armor'].includes(item.type)) {
                        actions = `
                            <button class="act-btn" onclick="game.toggleEquip(${item.id})">
                                ${item.equipped ? '–°–ù–Ø–¢–¨' : '–ù–ê–î–ï–¢–¨'}
                            </button>
                            <button class="act-btn" onclick="game.upgradeItem(${item.id})">–£–õ–£–ß–®–ò–¢–¨</button>
                        `;
                    } else if (item.type === 'potion') {
                        actions = `<button class="act-btn" onclick="game.usePotion(${item.id})">–ü–ò–¢–¨</button>`;
                    }

                    list.innerHTML += `
                        <div class="card">
                            <b>${item.name}${countText}</b><br>
                            <small>${item.str ? '+' + item.str + ' –°–ò–õ–´' : ''}${item.def ? ' +' + item.def + ' –ë–†–û–ù–ò' : ''}</small>
                            <div class="item-actions">
                                ${actions}
                            </div>
                        </div>`;
                });
            },

            openChest(id) {
                const item = this.state.inventory.find(x => x.id === id);
                if (!item || item.type !== 'chest') return;

                const reward = Math.floor(Math.random() * 51) + 50; // 50-100
                this.state.coins += reward;

                if (item.count > 1) {
                    item.count -= 1;
                } else {
                    this.state.inventory = this.state.inventory.filter(x => x.id !== id);
                }

                this.updateUI();
                this.msg(`üéÅ –û—Ç–∫—Ä—ã—Ç —Å—É–Ω–¥—É–∫! +${reward} üí∞`);
            },

            sellItem(id) {
                const item = this.state.inventory.find(x => x.id === id);
                if (!item || item.type !== 'material') return;

                const sellPrice = 2;
                const count = item.count || 1;
                this.state.coins += sellPrice * count;

                if (count > 1) {
                    item.count -= 1;
                } else {
                    this.state.inventory = this.state.inventory.filter(x => x.id !== id);
                }

                this.updateUI();
                this.msg(`üí∞ –ü—Ä–æ–¥–∞–Ω–æ! +${sellPrice * count} –º–æ–Ω–µ—Ç`);
            },

            toggleEquip(id) {
                const item = this.state.inventory.find(x => x.id === id);
                if (!item || !['weapon', 'tool', 'armor'].includes(item.type)) return;

                if (item.type === 'weapon') {
                    this.state.inventory.forEach(x => {
                        if (x.type === 'weapon') x.equipped = false;
                    });
                } else if (item.type === 'armor') {
                    // –î–ª—è –±—Ä–æ–Ω–∏ –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–ª–æ—Ç—ã
                }
                
                item.equipped = !item.equipped;
                this.updateUI();
                this.msg(item.equipped ? `‚úÖ ${item.name} —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω` : `‚ùå ${item.name} —Å–Ω—è—Ç`);
            },
            
            upgradeItem(id) {
                const item = this.state.inventory.find(x => x.id === id);
                if (!item) return;
                
                const upgradeCost = 100;
                if (this.state.coins >= upgradeCost) {
                    this.state.coins -= upgradeCost;
                    if (item.str) item.str += 5;
                    if (item.def) item.def += 3;
                    this.updateUI();
                    this.msg(`‚ö° ${item.name} —É–ª—É—á—à–µ–Ω!`);
                } else {
                    this.msg('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è');
                }
            },
            
            usePotion(id) {
                const item = this.state.inventory.find(x => x.id === id);
                if (!item || item.type !== 'potion') return;
                
                this.state.stats.hp = Math.min(this.state.stats.max_hp, this.state.stats.hp + 30);
                
                if (item.count > 1) {
                    item.count -= 1;
                } else {
                    this.state.inventory = this.state.inventory.filter(x => x.id !== id);
                }
                
                this.updateUI();
                this.msg('‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
            },

            switchTab(id, el) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                if (el) {
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    el.classList.add('active');
                }
            },

            showModal(id) {
                document.getElementById(id).style.display = 'block';
                if (id === 'skillsModal') {
                    let h = '';
                    Object.values(this.state.skills).forEach(s => {
                        const progress = (s.xp / s.next * 100).toFixed(1);
                        h += `
                            <div class="card">
                                <b>${s.label} LVL ${s.lvl}</b><br>
                                <small>${Math.floor(s.xp)} / ${Math.floor(s.next)} XP</small>
                                <div class="hp-bar" style="margin-top:8px;">
                                    <div class="hp-fill" style="width:${progress}%; background:var(--green);"></div>
                                </div>
                            </div>`;
                    });
                    document.getElementById('skills-content').innerHTML = h;
                }
                if (id === 'leadModal') this.switchLead('coins');
            },

            closeModal(id) {
                document.getElementById(id).style.display = 'none';
            },

            async switchLead(type) {
                document.querySelectorAll('#leadModal .inv-tab').forEach(b => b.classList.remove('active'));
                document.getElementById('l-tab-' + (type === 'coins' ? 'coins' : 'lvl')).classList.add('active');
                
                const leaders = await this.getLeaderboard(type);
                let html = '';
                
                if (leaders.length > 0) {
                    leaders.forEach(leader => {
                        html += `
                            <div class="card">
                                <b>${leader.rank}. ${leader.name}</b> 
                                <span style="float:right; color:var(--accent)">${leader.value}</span>
                            </div>`;
                    });
                } else {
                    // –û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º
                    const totalLvl = Object.values(this.state.skills).reduce((a, b) => a + b.lvl, 0) - 5;
                    const value = type === 'coins' 
                        ? `${Math.floor(this.state.coins).toLocaleString()} üí∞` 
                        : `LVL ${(totalLvl / 10).toFixed(2)}`;
                    
                    html = `
                        <div class="card">
                            <b>1. ${tg.initDataUnsafe?.user?.username ? '@' + tg.initDataUnsafe.user.username : '–í—ã'}</b> 
                            <span style="float:right; color:var(--accent)">${value}</span>
                        </div>
                        <div class="card" style="text-align:center; color:#666;">
                            –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ Telegram –¥–ª—è –ø–æ–ª–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤
                        </div>`;
                }
                
                document.getElementById('lead-list').innerHTML = html;
            },

            msg(t) {
                tg.showAlert(t);
            }
        };

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
        game.init();
    </script>
</body>
</html>

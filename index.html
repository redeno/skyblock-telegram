<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyBlock Mobile RPG</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0b0b0d; --card: #16161a; --accent: #ffaa00;
            --blue: #5555ff; --red: #ff5555; --gray: #aaaaaa; --white: #ffffff;
            --green: #55ff55; --dark-gray: #333333;
        }
        body {margin:0;padding:0;background:var(--bg);color:var(--white);font-family:'Courier New',monospace;display:flex;flex-direction:column;height:100vh;overflow:hidden;}
        #header-ui {padding:10px 15px;display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,0.8);border-bottom:2px solid var(--dark-gray);}
        .sb-lvl-badge {color:var(--accent);font-weight:bold;border:1px solid var(--accent);padding:4px 8px;border-radius:4px;font-size:0.9rem;}
        .top-btn {background:var(--dark-gray);border:1px solid #555;color:white;padding:6px 10px;border-radius:4px;font-size:0.75rem;cursor:pointer;}
        #viewport {flex:1;overflow-y:auto;padding:15px;padding-bottom:90px;}
        .screen {display:none;}
        .screen.active {display:block;}
        .card {background:var(--card);border:2px solid var(--dark-gray);padding:15px;margin-bottom:12px;border-radius:8px;}
        .stat-grid {display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:0.85rem;}
        .stat-label {color:var(--gray);}
        .stat-val {color:var(--red);font-weight:bold;}
        .cooldown-btn {position:relative;width:100%;height:55px;background:#222;border:2px solid #444;color:white;font-weight:bold;cursor:pointer;overflow:hidden;margin-top:5px;border-radius:8px;}
        .progress-overlay {position:absolute;top:0;left:0;height:100%;width:0%;background:rgba(255,170,0,0.3);}
        .portal-grid {display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
        .portal-node {background:#222;border:2px solid #444;padding:15px;text-align:center;font-size:0.9rem;cursor:pointer;border-radius:8px;}
        #nav {position:fixed;bottom:0;width:100%;height:70px;background:#1c1c1c;display:flex;border-top:3px solid var(--dark-gray);}
        .nav-item {flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#777;font-size:0.7rem;background:none;border:none;text-transform:uppercase;font-weight:bold;cursor:pointer;}
        .nav-item.active {color:var(--accent);background:#252525;}
        .nav-item span {font-size:1.4rem;margin-bottom:2px;}
        .modal {display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:1000;padding:20px;overflow-y:auto;}
        .hp-bar {width:100%;height:12px;background:#333;border:1px solid #555;margin:8px 0;border-radius:6px;overflow:hidden;}
        .hp-fill {height:100%;background:var(--red);transition:width 0.2s;}
        .inv-tabs {display:flex;gap:5px;overflow-x:auto;margin-bottom:15px;padding-bottom:5px;}
        .inv-tab {background:#222;border:1px solid #444;color:#888;padding:6px 12px;font-size:0.7rem;white-space:nowrap;border-radius:4px;cursor:pointer;}
        .inv-tab.active {border-color:var(--accent);color:var(--white);}
        .item-actions {display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-top:8px;}
        .act-btn {background:#333;border:1px solid #555;color:white;padding:4px;font-size:0.65rem;border-radius:4px;cursor:pointer;}
    </style>
</head>
<body>
    <div id="header-ui">
        <button class="top-btn" onclick="game.showModal('skillsModal')">‚öôÔ∏è –°–ö–ò–õ–õ–´</button>
        <div class="sb-lvl-badge">LVL <span id="sb-lvl">0.00</span></div>
        <button class="top-btn" onclick="game.showModal('leadModal')">üèÜ –¢–û–ü</button>
    </div>
    <div id="viewport">
        <div id="home" class="screen active">
            <div class="card" style="text-align:center"><h1 style="margin:0;color:var(--accent)">üí∞ <span id="coins-val">0</span></h1><small style="color:var(--gray)">–¢–í–û–ò –ú–û–ù–ï–¢–´</small></div>
            <div class="card"><div class="stat-grid" id="stats-display"></div></div>
        </div>
        <div id="portal" class="screen">
            <h3 style="text-align:center;margin-top:0">üåÄ –ü–û–†–¢–ê–õ</h3>
            <div class="portal-grid">
                <div class="portal-node" onclick="game.goLoc('mine')">‚õèÔ∏è –®–ê–•–¢–ê</div>
                <div class="portal-node" onclick="game.goLoc('farm')">üåæ –§–ï–†–ú–ê</div>
                <div class="portal-node" onclick="game.goLoc('fish')">üé£ –†–´–ë–ê–õ–ö–ê</div>
                <div class="portal-node" onclick="game.goLoc('forage')">üå≤ –õ–ï–°</div>
                <div class="portal-node" onclick="game.switchTab('dungeons-menu')">üíÄ –î–ê–ù–ñ–ò</div>
                <div class="portal-node" onclick="game.msg('–°–∫–æ—Ä–æ...')">üëπ –°–õ–ï–ô–ï–†–´</div>
                <div class="portal-node" onclick="game.switchTab('shop')">üõí –ú–ê–ì–ê–ó–ò–ù</div>
                <div class="portal-node" onclick="game.msg('–°–∫–æ—Ä–æ...')">‚öñÔ∏è –û–ë–ú–ï–ù</div>
                <div class="portal-node" onclick="game.msg('–°–∫–æ—Ä–æ...')">üìÖ –ò–í–ï–ù–¢</div>
                <div class="portal-node" onclick="game.msg('–°–∫–æ—Ä–æ...')">üó≥Ô∏è –ú–≠–†</div>
            </div>
        </div>
        <div id="action-loc" class="screen">
            <button class="top-btn" onclick="game.switchTab('portal')">‚Üê –ù–ê–ó–ê–î</button>
            <h2 id="loc-title" style="text-align:center;text-transform:uppercase">–®–ê–•–¢–ê</h2>
            <div class="card" style="text-align:center">
                <button id="action-btn" class="cooldown-btn" onclick="game.executeAction()">
                    <div id="action-prog" class="progress-overlay"></div>
                    <span style="position:relative">–†–ê–ë–û–¢–ê–¢–¨</span>
                </button>
            </div>
            <div id="loc-log" style="text-align:center;color:var(--green);min-height:20px;margin-top:10px;"></div>
        </div>
        <div id="dungeons-menu" class="screen">
            <button class="top-btn" onclick="game.switchTab('portal')">‚Üê –ù–ê–ó–ê–î</button>
            <h3>üíÄ –ö–ê–¢–ê–ö–û–ú–ë–´</h3>
            <div class="card"><p>–≠–¢–ê–ñ I</p><button class="cooldown-btn" onclick="game.startDungeon(1)">–í–û–ô–¢–ò</button></div>
            <div class="card"><p>–≠–¢–ê–ñ II</p><button class="cooldown-btn" onclick="game.startDungeon(2)">–í–û–ô–¢–ò</button></div>
            <div class="card"><p>–≠–¢–ê–ñ III</p><button class="cooldown-btn" onclick="game.startDungeon(3)">–í–û–ô–¢–ò</button></div>
            <div class="card"><p>–≠–¢–ê–ñ IV</p><button class="cooldown-btn" onclick="game.startDungeon(4)">–í–û–ô–¢–ò</button></div>
            <div class="card"><p>–≠–¢–ê–ñ V</p><button class="cooldown-btn" onclick="game.startDungeon(5)">–í–û–ô–¢–ò</button></div>
            <div class="card"><p>–≠–¢–ê–ñ VI</p><button class="cooldown-btn" onclick="game.startDungeon(6)">–í–û–ô–¢–ò</button></div>
        </div>
        <div id="battle-screen" class="screen">
            <h2 id="mob-name" style="text-align:center;color:var(--red)">–ú–û–ù–°–¢–†</h2>
            <div class="card"><div style="display:flex;justify-content:space-between"><span>–•–ü –í–†–ê–ì–ê</span><span id="m-hp-txt">50/50</span></div><div class="hp-bar"><div id="m-hp-fill" class="hp-fill" style="width:100%"></div></div></div>
            <div class="card" style="border-color:var(--blue)"><div style="display:flex;justify-content:space-between"><span>–¢–í–û–Å –•–ü</span><span id="p-hp-txt">100/100</span></div><div class="hp-bar"><div id="p-hp-fill" class="hp-fill" style="width:100%;background:var(--blue)"></div></div></div>
            <button class="cooldown-btn" style="height:80px" onclick="game.dungeonAttack()">üí• –£–î–ê–†–ò–¢–¨</button>
        </div>
        <div id="loot-screen" class="screen">
            <h2 style="text-align:center;color:var(--accent)">–ü–û–ë–ï–î–ê!</h2>
            <p style="text-align:center;font-size:1.2rem">üéÅ –°—É–Ω–¥—É–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!</p>
            <button class="cooldown-btn" onclick="game.switchTab('portal')">–í–ï–†–ù–£–¢–¨–°–Ø –ù–ê –ü–û–†–¢–ê–õ</button>
        </div>
        <div id="shop" class="screen">
            <button class="top-btn" onclick="game.switchTab('portal')">‚Üê –ù–ê–ó–ê–î</button>
            <h3>üõí –ú–ê–ì–ê–ó–ò–ù</h3>
            <div class="inv-tabs">
                <div class="inv-tab active" onclick="game.shopFilter('weapon',this)">–û–†–£–ñ–ò–ï</div>
                <div class="inv-tab" onclick="game.shopFilter('armor',this)">–ë–†–û–ù–Ø</div>
                <div class="inv-tab" onclick="game.shopFilter('tool',this)">–ò–ù–°–¢–†–£–ú–ï–ù–¢–´</div>
                <div class="inv-tab" onclick="game.shopFilter('accessory',this)">–¢–ê–õ–ò–°–ú–ê–ù–´</div>
                <div class="inv-tab" onclick="game.shopFilter('buff',this)">–ë–ê–§–§–´</div>
            </div>
            <div id="shop-list"></div>
        </div>
        <div id="minions" class="screen">
            <div class="card" style="border-color:var(--accent);text-align:center">–ö–û–®–ï–õ–ï–ö: <span id="m-coins-val" style="color:var(--accent)">0</span> üí∞</div>
            <div id="minions-list"></div>
        </div>
        <div id="inventory" class="screen">
            <div class="inv-tabs">
                <div class="inv-tab active" onclick="game.filterInv('weapon',this)">–û–†–£–ñ–ò–ï</div>
                <div class="inv-tab" onclick="game.filterInv('armor',this)">–ë–†–û–ù–Ø</div>
                <div class="inv-tab" onclick="game.filterInv('tool',this)">–ò–ù–°–¢–†–£–ú–ï–ù–¢–´</div>
                <div class="inv-tab" onclick="game.filterInv('accessory',this)">–¢–ê–õ–ò–°–ú–ê–ù–´</div>
                <div class="inv-tab" onclick="game.filterInv('material',this)">–ú–ê–¢–ï–†–ò–ê–õ</div>
                <div class="inv-tab" onclick="game.filterInv('chest',this)">–°–£–ù–î–£–ö–ò</div>
            </div>
            <div id="inv-list"></div>
        </div>
    </div>
    <div id="skillsModal" class="modal">
        <span style="float:right;font-weight:bold;cursor:pointer" onclick="game.closeModal('skillsModal')">[–ó–ê–ö–†–´–¢–¨]</span>
        <h3>üìä –¢–í–û–ò –ù–ê–í–´–ö–ò</h3>
        <div id="skills-content"></div>
        <h3>–ö–õ–ê–°–°</h3>
        <select id="class-select" onchange="game.setClass(this.value)">
            <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>
            <option value="berserk">–ë–µ—Ä—Å–µ—Ä–∫</option>
            <option value="archer">–ê—Ä—á–µ—Ä</option>
            <option value="tank">–¢–∞–Ω–∫</option>
            <option value="mage">–ú–∞–≥</option>
            <option value="healer">–•–∏–ª–ª–µ—Ä</option>
        </select>
    </div>
    <div id="leadModal" class="modal">
        <span style="float:right;font-weight:bold;cursor:pointer" onclick="game.closeModal('leadModal')">[–ó–ê–ö–†–´–¢–¨]</span>
        <h3>üèÜ –¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</h3>
        <div id="lead-list"></div>
    </div>
    <nav id="nav">
        <button class="nav-item active" onclick="game.switchTab('home',this)"><span>üè†</span>–î–û–ú</button>
        <button class="nav-item" onclick="game.switchTab('portal',this)"><span>üåÄ</span>–ü–û–†–¢–ê–õ</button>
        <button class="nav-item" onclick="game.switchTab('minions',this)"><span>üë∑</span>–ú–ò–ù–¨–û–ù–´</button>
        <button class="nav-item" onclick="game.switchTab('inventory',this)"><span>üéí</span>–ò–ù–í–ï–ù–¢–ê–†–¨</button>
    </nav>

    <script>
        const tg = window.Telegram?.WebApp || {};
        const SAVE_KEY = 'skyblock_save_v3';

        const defaultState = {
            coins: 0,
            nextItemId: 10,
            skills: {
                mining: {lvl:1,xp:0,next:100,label:'–®–ê–•–¢–ê'},
                farming: {lvl:1,xp:0,next:100,label:'–§–ï–†–ú–ê'},
                fishing: {lvl:1,xp:0,next:100,label:'–†–´–ë–ê–õ–ö–ê'},
                combat: {lvl:1,xp:0,next:100,label:'–ë–û–ô'},
                foraging: {lvl:1,xp:0,next:100,label:'–õ–ï–°'},
                dungeons: {lvl:1,xp:0,next:200,label:'–î–ê–ù–ñ–ò'}
            },
            stats: {hp:100,str:10,def:0,cc:5,cd:50,mf:0,int:0,mag_amp:0},
            class: '',
            buffs: {godpotion:{endTime:0}},
            inventory: [
                {id:1,name:'–°—Ç–∞—Ä—ã–π –º–µ—á',type:'weapon',str:15,equipped:false},
                {id:2,name:'–ù–∞—á–∞–ª—å–Ω–∞—è –∫–∏—Ä–∫–∞',type:'tool',sub_type:'pickaxe',equipped:true}
            ],
            minions: [
                {id:'wheat',name:'–ü–®–ï–ù–ò–ß–ù–´–ô',cost:50,count:0,stored:0,rate:0.5},
                {id:'fish',name:'–†–´–ë–ù–´–ô',cost:75,count:0,stored:0,rate:0.75},
                {id:'oak',name:'–î–£–ë–û–í–´–ô',cost:100,count:0,stored:0,rate:1.0},
                {id:'coal',name:'–£–ì–û–õ–¨–ù–´–ô',cost:125,count:0,stored:0,rate:1.5}
            ]
        };

        const shopItems = {
            weapon: [
                {name:'–ö–∞–º–µ–Ω–Ω—ã–π –º–µ—á',type:'weapon',str:10,cost:1000},
                {name:'–ñ–µ–ª–µ–∑–Ω—ã–π –ú–µ—á',type:'weapon',str:20,cost:5000},
                {name:'–ê–ª–º–∞–∑–Ω—ã–π –ú–µ—á',type:'weapon',str:30,cost:20000},
                {name:'–ù–µ–∑–µ—Ä–∏—Ç–æ–≤—ã–π –ú–µ—á',type:'weapon',str:50,cost:100000},
                {name:'–ú–µ—á –ú–∏–¥–∞—Å–∞',type:'weapon',dynamic_str:'midas',cost:5000000},
                {name:'–ú–µ—á –ì–∏–≥–∞–Ω—Ç–∞',type:'weapon',str:100,cd:50,cost:50000000},
                {name:'–ì–∏–ø–µ—Ä–∏–æ–Ω',type:'weapon',magic:true,cost:500000000}
            ],
            armor: [
                {name:'–ñ–µ–ª–µ–∑–Ω–∞—è –ë—Ä–æ–Ω—è',type:'armor',def:10,cost:10000},
                {name:'–ê–ª–º–∞–∑–Ω–∞—è –±—Ä–æ–Ω—è',type:'armor',def:20,cost:50000},
                {name:'Shaddow Assasins –±—Ä–æ–Ω—è',type:'armor',def:25,str:25,cc:5,cd:10,cost:1000000},
                {name:'–î–µ–º–æ–Ω–õ–æ—Ä–¥ –ë—Ä–æ–Ω—è',type:'armor',str:50,def:30,cc:10,cd:25,mag_amp:5,mf:25,cost:10000000}
            ],
            tool: [
                {name:'–î–µ—Ä–µ–≤—è–Ω–Ω–∞—è –º–æ—Ç—ã–≥–∞',type:'tool',sub_type:'hoe',double_chance:5,cost:2000},
                {name:'–î–µ—Ä–µ–≤—è–Ω–Ω–∞—è –∫–∏—Ä–∫–∞',type:'tool',sub_type:'pickaxe',double_chance:5,cost:2000},
                {name:'–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π —Ç–æ–ø–æ—Ä',type:'tool',sub_type:'axe',double_chance:5,cost:2000},
                {name:'–û–±—ã—á–Ω–∞—è —É–¥–æ—á–∫–∞',type:'tool',sub_type:'rod',double_chance:5,cost:2000},
                {name:'–ö–∞–º–µ–Ω–Ω–∞—è –º–æ—Ç—ã–≥–∞',type:'tool',sub_type:'hoe',double_chance:10,cost:10000},
                {name:'–ö–∞–º–µ–Ω–Ω–∞—è –∫–∏—Ä–∫–∞',type:'tool',sub_type:'pickaxe',double_chance:10,cost:10000},
                {name:'–ö–∞–º–µ–Ω–Ω—ã–π —Ç–æ–ø–æ—Ä',type:'tool',sub_type:'axe',double_chance:10,cost:10000},
                {name:'–ù–µ–æ–±—ã–∫–Ω–æ–≤–µ–Ω–Ω–∞—è —É–¥–æ—á–∫–∞',type:'tool',sub_type:'rod',double_chance:10,cost:100000},
                {name:'–ë—ã—Å—Ç—Ä–∞—è –£–¥–æ—á–∫–∞',type:'tool',sub_type:'rod',double_chance:50,fast:true,cost:1000000},
                {name:'–í–µ–ª–∏–∫–∞—è —É–¥–æ—á–∫–∞',type:'tool',sub_type:'rod',double_chance:30,xp_bonus:5,cost:25000000},
                {name:'–£–¥–æ—á–∫–∞ –≥–∏–≥–∞–Ω—Ç–∞',type:'tool',sub_type:'rod',double_chance:50,triple_chance:25,xp_bonus:10,cost:100000000},
                {name:'–£–¥–æ—á–∫–∞ –≥–µ—Ä–æ—è',type:'tool',sub_type:'rod',double_chance:100,triple_chance:25,xp_bonus:20,cost:500000000}
            ],
            accessory: [
                {name:'–¢–∞–ª–∏—Å–º–∞–Ω —É–¥–∞—á–∏',type:'accessory',mf:10,cost:10000},
                {name:'–¢–∞–ª–∏—Å–º–∞–Ω —Å–∏–ª—ã',type:'accessory',str:5,cost:5000},
                {name:'–¢–∞–ª–∏—Å–º–∞–Ω –∑–∞—â–∏—Ç—ã',type:'accessory',def:5,cost:5000},
                {name:'–¢–∞–ª–∏—Å–º–∞–Ω –º–æ—â–∏',type:'accessory',cd:5,cc:1,cost:10000},
                {name:'–¢–∞–ª–∏—Å–º–∞–Ω –∑–Ω–∞–Ω–∏–π',type:'accessory',int:5,cost:5000},
                {name:'–¢–∞–ª–∏—Å–º–∞–Ω –¥—Ä–µ–≤–Ω–∏—Ö –∑–Ω–∞–Ω–∏–π',type:'accessory',int:25,mag_amp:1,cost:1000000},
                {name:'–ö–æ–ª—å—Ü–æ –æ–ø—ã—Ç–∞',type:'accessory',xp_bonus:1,cost:100000}
            ],
            buff: [{name:'GodPotion',type:'potion',cost:1000000}]
        };

        const dungeonRewards = {
            1:{coins_min:50,coins_max:250,drops:[]},
            2:{coins_min:300,coins_max:500,drops:[{chance:1,items:[{name:'–¢–∞–ª–∏—Å–º–∞–Ω —Å–∏–ª—ã +1',type:'accessory',str:1},{name:'–¢–∞–ª–∏—Å–º–∞–Ω –∫—Ä–∏—Ç–∞ +1',type:'accessory',cd:1},{name:'–¢–∞–ª–∏—Å–º–∞–Ω —É–¥–∞—á–∏ +1',type:'accessory',mf:1}]}]},
            3:{coins_min:1000,coins_max:2500,drops:[{chance:1,item:{name:'–¢–∞–ª–∏—Å–º–∞–Ω –∑–∞—â–∏—Ç—ã',type:'accessory',def:20}}]},
            4:{coins_min:5000,coins_max:25000,drops:[{chance:1,item:{name:'–ú–µ—á –ú–∏–¥–∞—Å–∞',type:'weapon',dynamic_str:'midas'}},{chance:1,item:{name:'–¢–∞–ª–∏—Å–º–∞–Ω –∑–æ–ª–æ—Ç–∞',type:'accessory',gold_bonus:5}}]},
            5:{coins_min:10000,coins_max:40000,drops:[{chance:3,item:{name:'–ú–µ—á –ì–∏–≥–∞–Ω—Ç–∞',type:'weapon',str:100,cd:50}},{chance:5,item:{name:'–ú–µ—á –ú–∏–¥–∞—Å–∞',type:'weapon',dynamic_str:'midas'}}]},
            6:{coins_min:100000,coins_max:500000,drops:[{chance:0.5,item:{name:'–ì–∏–ø–µ—Ä–∏–æ–Ω',type:'weapon',magic:true}}]}
        };

        const game = {
            state: {...defaultState},
            dungeon: {floor:1,mobIdx:0,mobHp:50,pHp:100,pMaxHp:100,mobs:['–ó–û–ú–ë–ò','–°–ö–ï–õ–ï–¢','–ü–ê–£–ö','–ë–û–°–°']},
            isBusy:false,
            currentLoc:'',
            lastFilter:'weapon',
            lastShopFilter:'weapon',

            load(){const s=localStorage.getItem(SAVE_KEY);if(s)try{this.state=JSON.parse(s)}catch(e){this.state={...defaultState}}},
            save(){localStorage.setItem(SAVE_KEY,JSON.stringify(this.state))},
            init(){this.load();this.updateUI();setInterval(()=>this.minionTick(),1000);setInterval(()=>this.save(),5000);tg.expand?.()},
            msg(t){alert(t)}, // –û–±—ã—á–Ω—ã–π alert ‚Äî –±–µ–∑ –æ—à–∏–±–æ–∫ Telegram

            addMaterial(n,t='material'){const e=this.state.inventory.find(i=>i.name===n&&i.type===t);if(e)e.count=(e.count||1)+1;else this.state.inventory.push({id:this.state.nextItemId++,name:n,type:t,count:1})},
            addXp(k,a){const sk=this.state.skills[k];sk.xp+=a;if(sk.xp>=sk.next){sk.lvl++;sk.xp=0;sk.next*=1.6;this.msg(`LEVEL UP! ${sk.label} ${sk.lvl}`)}},
            getEquippedTool(){const m={mine:'pickaxe',farm:'hoe',fish:'rod',forage:'axe'};return this.state.inventory.find(i=>i.equipped&&i.type==='tool'&&i.sub_type===m[this.currentLoc])},
            calcStats(){
                let s={...this.state.stats,xp_bonus:0,gold_bonus:0};
                this.state.inventory.forEach(i=>{if(i.equipped){
                    ['str','def','cc','cd','mf','int','mag_amp','xp_bonus','gold_bonus'].forEach(st=>i[st]?s[st]+=i[st]:0);
                    if(i.dynamic_str==='midas')s.str+=Math.floor(25*(this.state.coins/1000000));
                }});
                if(Date.now()<this.state.buffs.godpotion.endTime){s.str+=50;s.cc+=10;s.cd+=25;s.mf+=10;s.def+=50;s.int+=50;s.mag_amp+=5}
                const c=this.state.class;
                if(c==='healer')Object.keys(s).forEach(k=>s[k]*=1.05);
                else if(c==='tank'){s.def*=1.3;s.str*=1.05}
                else if(c==='mage'){s.mag_amp*=1.2}
                return s;
            },
            updateUI(){
                const coins = Number(this.state.coins)||0;
                document.getElementById('coins-val').innerText=Math.floor(coins).toLocaleString();
                document.getElementById('m-coins-val').innerText=Math.floor(coins).toLocaleString();
                const tl=Object.values(this.state.skills).reduce((a,b)=>a+b.lvl,0)-6;
                document.getElementById('sb-lvl').innerText=(tl/10).toFixed(2);
                const s=this.calcStats();
                document.getElementById('stats-display').innerHTML=`
                    <div><span class="stat-label">‚ù§Ô∏è –ó–î–û–†–û–í–¨–ï:</span> <span class="stat-val">${Math.floor(s.hp)}</span></div>
                    <div><span class="stat-label">‚öîÔ∏è –°–ò–õ–ê:</span> <span class="stat-val">${Math.floor(s.str)}</span></div>
                    <div><span class="stat-label">üõ°Ô∏è –ë–†–û–ù–Ø:</span> <span class="stat-val">${Math.floor(s.def)}</span></div>
                    <div><span class="stat-label">üí• –ö–†–ò–¢ –®–ê–ù–°:</span> <span class="stat-val">${Math.floor(s.cc)}%</span></div>
                    <div><span class="stat-label">üî• –ö–†–ò–¢ –£–†–û–ù:</span> <span class="stat-val">${Math.floor(s.cd)}%</span></div>
                    <div><span class="stat-label">üçÄ –£–î–ê–ß–ê:</span> <span class="stat-val">${Math.floor(s.mf)}</span></div>
                    <div><span class="stat-label">üß† –ò–ù–¢–ï–õ–õ–ï–ö–¢:</span> <span class="stat-val">${Math.floor(s.int)}</span></div>
                    <div><span class="stat-label">üîÆ –ú–ê–ì –£–°–ò–õ–ï–ù–ò–ï:</span> <span class="stat-val">${Math.floor(s.mag_amp)}</span></div>`;
                this.renderMinions();this.renderInvList(this.lastFilter);
                if(document.getElementById('shop').classList.contains('active'))this.renderShopList(this.lastShopFilter);
                if(document.getElementById('skillsModal').style.display==='block')this.showModal('skillsModal');
                document.getElementById('class-select').value=this.state.class;
                this.save();
            },
            goLoc(l){this.currentLoc=l;this.switchTab('action-loc');const t={mine:'–®–ê–•–¢–ê',farm:'–§–ï–†–ú–ê',fish:'–†–´–ë–ê–õ–ö–ê',forage:'–õ–ï–°'};document.getElementById('loc-title').innerText=t[l]||'–õ–û–ö–ê–¶–ò–Ø';document.getElementById('loc-log').innerText=''},
            executeAction(){if(this.isBusy)return;this.isBusy=true;const p=document.getElementById('action-prog'),b=document.getElementById('action-btn');b.disabled=true;p.style.width='0%';const time=1500;setTimeout(()=>{p.style.transition=`width ${time/1000}s linear`;p.style.width='100%'},20);setTimeout(()=>{this.isBusy=false;b.disabled=false;p.style.transition='none';p.style.width='0%';this.finishAction()},time+20)},
            finishAction(){
                const m={mine:'mining',farm:'farming',fish:'fishing',forage:'foraging'},sk=this.state.skills[m[this.currentLoc]];
                const g=15*sk.lvl;this.state.coins+=g;this.addXp(m[this.currentLoc],20);
                const mat={mine:'–£–≥–æ–ª—å',farm:'–ü—à–µ–Ω–∏—Ü–∞',fish:'–†—ã–±–∞',forage:'–î–µ—Ä–µ–≤–æ'}[this.currentLoc];
                this.addMaterial(mat);
                document.getElementById('loc-log').innerText=`+${g} üí∞ | +20 XP | +1 ${mat}`;
                this.updateUI();
            },
            startDungeon(f){
                const req=(f-1)*5+1;
                if(this.state.skills.dungeons.lvl<req){this.msg(`–ù—É–∂–µ–Ω —É—Ä–æ–≤–µ–Ω—å –î–ê–ù–ñ–ï–ô ${req}`);return}
                const s=this.calcStats();
                this.dungeon={floor:f,mobIdx:0,mobHp:50*f,pHp:s.hp,pMaxHp:s.hp,mobs:['–ó–û–ú–ë–ò','–°–ö–ï–õ–ï–¢','–ü–ê–£–ö','–ë–û–°–°']};
                this.updateBattleUI();this.switchTab('battle-screen');
            },
            dungeonAttack(){
                const s=this.calcStats(),w=this.state.inventory.find(i=>i.equipped&&i.type==='weapon');
                let dmg=w&&w.magic?s.int*s.mag_amp*100:s.str;
                if(Math.random()*100<s.cc){dmg*=(1+s.cd/100);this.msg('–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–î–ê–†!')}
                this.dungeon.mobHp-=dmg;
                const ed=(this.dungeon.mobIdx===3?6:4)*this.dungeon.floor;
                this.dungeon.pHp-=Math.max(1,ed-s.def);
                if(this.dungeon.mobHp<=0){
                    this.addXp('combat',this.dungeon.mobIdx===3?50:20);
                    this.dungeon.mobIdx++;
                    if(this.dungeon.mobIdx>=4){this.giveDungeonReward();this.switchTab('loot-screen')}
                    else{this.dungeon.mobHp=(this.dungeon.mobIdx===3?80:50)*this.dungeon.floor;this.dungeon.pHp=Math.min(this.dungeon.pMaxHp,this.dungeon.pHp+this.dungeon.pMaxHp*0.2);this.msg('–ú–û–ë –£–ë–ò–¢! +20% –•–ü');this.updateBattleUI()}
                }
                if(this.dungeon.pHp<=0){this.msg(`–¢–´ –£–ú–ï–† –Ω–∞ —ç—Ç–∞–∂–µ ${this.dungeon.floor}!`);this.switchTab('portal')}
                else this.updateBattleUI();
            },
            giveDungeonReward(){
                const s=this.calcStats(),r=dungeonRewards[this.dungeon.floor];
                let c=Math.floor(Math.random()*(r.coins_max-r.coins_min+1)+r.coins_min);
                c=Math.floor(c*(1+s.gold_bonus/100));this.state.coins+=c;
                this.addXp('dungeons',this.dungeon.floor*100);
                r.drops?.forEach(d=>{if(Math.random()*100<d.chance+s.mf){const it=d.item||d.items[Math.floor(Math.random()*d.items.length)];this.state.inventory.push({...it,id:this.state.nextItemId++,equipped:false});this.msg(`–í—ã–ø–∞–ª ${it.name}!`)}});
                this.addMaterial(`–°—É–Ω–¥—É–∫ —ç—Ç–∞–∂–∞ ${this.dungeon.floor}`,'chest');
                this.updateUI();
            },
            updateBattleUI(){
                document.getElementById('mob-name').innerText=this.dungeon.mobs[this.dungeon.mobIdx];
                const max=(this.dungeon.mobIdx===3?80:50)*this.dungeon.floor;
                document.getElementById('m-hp-txt').innerText=`${Math.max(0,Math.floor(this.dungeon.mobHp))}/${max}`;
                document.getElementById('m-hp-fill').style.width=`${Math.max(0,this.dungeon.mobHp/max*100)}%`;
                document.getElementById('p-hp-txt').innerText=`${Math.max(0,Math.floor(this.dungeon.pHp))}/${Math.floor(this.dungeon.pMaxHp)}`;
                document.getElementById('p-hp-fill').style.width=`${this.dungeon.pHp/this.dungeon.pMaxHp*100}%`;
            },
            renderMinions(){
                const l=document.getElementById('minions-list');l.innerHTML='';
                this.state.minions.forEach((m,i)=>{const buy=this.state.coins>=m.cost&&m.count<13,coll=m.stored>=0.1;l.innerHTML+=`<div class="card"><div style="display:flex;justify-content:space-between"><b>${m.name} (${m.count}/13)</b><span>üì¶ ${m.stored.toFixed(1)}/64</span></div><div class="item-actions"><button class="act-btn" ${!buy?'disabled':''} onclick="game.buyMinion(${i})">–ö–£–ü–ò–¢–¨ (${Math.floor(m.cost)}üí∞)</button><button class="act-btn" ${!coll?'disabled':''} onclick="game.collectMinion(${i})">–°–û–ë–†–ê–¢–¨ (${Math.floor(m.stored*20)}üí∞)</button></div></div>`});
            },
            buyMinion(i){const m=this.state.minions[i];if(this.state.coins>=m.cost&&m.count<13){this.state.coins-=m.cost;m.count++;m.cost*=1.5;m.rate*=1.2;this.updateUI();this.msg('–ú–∏–Ω—å–æ–Ω —É–ª—É—á—à–µ–Ω!')}},
            collectMinion(i){const m=this.state.minions[i];if(m.stored>=0.1){const g=Math.floor(m.stored*20);this.state.coins+=g;m.stored=0;this.updateUI();this.msg(`+${g} üí∞ –æ—Ç –º–∏–Ω—å–æ–Ω–∞!`)}},
            minionTick(){let u=false;this.state.minions.forEach(m=>{if(m.count>0){const o=m.stored;m.stored=Math.min(64,m.stored+m.rate*m.count/30);if(Math.floor(m.stored*10)>Math.floor(o*10))u=true}});if(u||document.querySelector('#minions.active')){this.renderMinions();document.getElementById('m-coins-val').innerText=Math.floor(this.state.coins).toLocaleString()}},
            getItemDesc(i){let d='';if(i.str)d+=`+${i.str} –°–ò–õ–´ `;if(i.def)d+=`+${i.def} –ë–†–û–ù–ò `;if(i.cc)d+=`+${i.cc}% –ö–†–ò–¢ –®–ê–ù–° `;if(i.cd)d+=`+${i.cd}% –ö–†–ò–¢ –£–†–û–ù `;if(i.mf)d+=`+${i.mf} –£–î–ê–ß–ò `;if(i.int)d+=`+${i.int} –ò–ù–¢–ï–õ–õ–ï–ö–¢–ê `;if(i.mag_amp)d+=`+${i.mag_amp} –ú–ê–ì –£–°–ò–õ–ï–ù–ò–Ø `;if(i.xp_bonus)d+=`+${i.xp_bonus}% –û–ü–´–¢–ê `;if(i.dynamic_str==='midas')d+='–ú–ò–î–ê–° ';if(i.magic)d+='–ú–ê–ì–ò–ß–ï–°–ö–û–ï ';return d||'–ü–†–ï–î–ú–ï–¢'},
            shopFilter(t,e){document.querySelectorAll('#shop .inv-tab').forEach(x=>x.classList.remove('active'));e.classList.add('active');this.lastShopFilter=t;this.renderShopList(t)},
            renderShopList(t){
                const l=document.getElementById('shop-list');l.innerHTML='';
                (shopItems[t]||[]).forEach((i,x)=>{l.innerHTML+=`<div class="card"><b>${i.name}</b><br><small>${this.getItemDesc(i)}</small><div class="item-actions"><button class="act-btn" onclick="game.buyShopItem('${t}',${x})">–ö–£–ü–ò–¢–¨ (${i.cost.toLocaleString()}üí∞)</button></div></div>`});
            },
            buyShopItem(t,x){
                const i=shopItems[t][x];
                if(this.state.coins<i.cost){this.msg('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç!');return}
                this.state.coins-=i.cost;
                this.state.inventory.push({...i,id:this.state.nextItemId++,equipped:false});
                this.msg(`${i.name} –∫—É–ø–ª–µ–Ω!`);
                this.updateUI();
            },
            filterInv(t,e){document.querySelectorAll('.inv-tab').forEach(x=>x.classList.remove('active'));e.classList.add('active');this.lastFilter=t;this.renderInvList(t)},
            renderInvList(t){
                const l=document.getElementById('inv-list');l.innerHTML='';const items=this.state.inventory.filter(i=>i.type===t);
                if(!items.length){l.innerHTML='<div class="card" style="text-align:center;color:#666">–ü—É—Å—Ç–æ</div>';return}
                items.forEach(i=>{
                    const c=i.count>1?` (${i.count})`:'';let a='';
                    if(i.type==='material')a=`<button class="act-btn" onclick="game.sellItem(${i.id})">–ü–†–û–î–ê–¢–¨</button>`;
                    if(i.type==='chest')a=`<button class="act-btn" onclick="game.openChest(${i.id})">–û–¢–ö–†–´–¢–¨</button>`;
                    if(['weapon','armor','tool','accessory'].includes(i.type))a=`<button class="act-btn" onclick="game.toggleEquip(${i.id})">${i.equipped?'–°–ù–Ø–¢–¨':'–ù–ê–î–ï–¢–¨'}</button>`;
                    if(i.type==='potion'&&i.name==='GodPotion')a=`<button class="act-btn" onclick="game.activateGodPotion(${i.id})">–ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨</button>`;
                    l.innerHTML+=`<div class="card"><b>${i.name}${c}</b><br><small>${this.getItemDesc(i)}</small><div class="item-actions">${a}</div></div>`;
                });
            },
            activateGodPotion(id){const i=this.state.inventory.find(x=>x.id===id);if(!i||i.name!=='GodPotion')return;if(Date.now()<this.state.buffs.godpotion.endTime){this.msg('–£–∂–µ –∞–∫—Ç–∏–≤–µ–Ω!');return}this.state.buffs.godpotion.endTime=Date.now()+86400000;this.state.inventory=this.state.inventory.filter(x=>x.id!==id);this.msg('GodPotion –Ω–∞ 24 —á–∞—Å–∞!');this.updateUI()},
            openChest(id){const i=this.state.inventory.find(x=>x.id===id);if(!i||i.type!=='chest')return;const r=Math.floor(Math.random()*51)+50;this.state.coins+=r;if(i.count>1)i.count--;else this.state.inventory=this.state.inventory.filter(x=>x.id!==id);this.updateUI();this.msg(`+${r} üí∞ –∏–∑ —Å—É–Ω–¥—É–∫–∞!`)},
            sellItem(id){const i=this.state.inventory.find(x=>x.id===id);if(!i||i.type!=='material')return;const p=2,c=i.count||1;this.state.coins+=p*c;if(c>1)i.count-=c;else this.state.inventory=this.state.inventory.filter(x=>x.id!==id);this.updateUI();this.msg(`–ü—Ä–æ–¥–∞–Ω–æ! +${p*c} üí∞`)},
            toggleEquip(id){const i=this.state.inventory.find(x=>x.id===id);if(!i||!['weapon','armor','tool','accessory'].includes(i.type))return;if(i.type==='weapon')this.state.inventory.forEach(x=>{if(x.type==='weapon'&&x.id!==id)x.equipped=false});if(i.type==='armor')this.state.inventory.forEach(x=>{if(x.type==='armor'&&x.id!==id)x.equipped=false});if(i.type==='tool')this.state.inventory.forEach(x=>{if(x.type==='tool'&&x.sub_type===i.sub_type&&x.id!==id)x.equipped=false});i.equipped=!i.equipped;this.updateUI()},
            switchTab(id,el){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');if(el){document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));el.classList.add('active')}},
            showModal(id){document.getElementById(id).style.display='block';if(id==='skillsModal'){let h='';Object.values(this.state.skills).forEach(s=>{const p=(s.xp/s.next*100).toFixed(1);h+=`<div class="card"><b>${s.label} LVL ${s.lvl}</b><br><small>${Math.floor(s.xp)} / ${Math.floor(s.next)} XP</small><div class="hp-bar" style="margin-top:8px"><div class="hp-fill" style="width:${p}%;background:var(--green)"></div></div></div>`});document.getElementById('skills-content').innerHTML=h}},
            closeModal(id){document.getElementById(id).style.display='none'},
            setClass(v){this.state.class=v;this.msg(v?`–ö–ª–∞—Å—Å: ${v}`:'–ö–ª–∞—Å—Å —Å–Ω—è—Ç');this.updateUI()}
        };

        game.init();
    </script>
</body>
</html>

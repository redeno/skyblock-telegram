<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SkyBlock Mobile RPG</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0b0b0d; --card: #16161a; --accent: #ffaa00;
            --blue: #5555ff; --red: #ff5555; --gray: #aaaaaa; --white: #ffffff;
            --green: #55ff55; --dark-gray: #333333;
        }
        body {
            margin: 0; padding: 0; background: var(--bg); color: var(--white);
            font-family: 'Courier New', Courier, monospace;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        #header-ui {
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.8); border-bottom: 2px solid var(--dark-gray);
        }
        .sb-lvl-badge { color: var(--accent); font-weight: bold; border: 1px solid var(--accent); padding: 4px 8px; border-radius: 4px; font-size: 0.9rem; }
        .top-btn { background: var(--dark-gray); border: 1px solid #555; color: white; padding: 6px 10px; border-radius: 4px; font-size: 0.75rem; }
        #viewport { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        .screen { display: none; }
        .screen.active { display: block; }
        .card { background: var(--card); border: 2px solid var(--dark-gray); padding: 15px; margin-bottom: 12px; border-radius: 8px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem; }
        .stat-label { color: var(--gray); }
        .stat-val { color: var(--red); font-weight: bold; }
        .cooldown-btn {
            position: relative; width: 100%; height: 55px; background: #222; border: 2px solid #444;
            color: white; font-weight: bold; cursor: pointer; overflow: hidden; margin-top: 5px; border-radius: 8px;
        }
        .progress-overlay { position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: rgba(255, 170, 0, 0.3); }
        .portal-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .portal-node { background: #222; border: 2px solid #444; padding: 15px; text-align: center; font-size: 0.9rem; cursor: pointer; border-radius: 8px; }
        #nav {
            position: fixed; bottom: 0; width: 100%; height: 70px;
            background: #1c1c1c; display: flex; border-top: 3px solid var(--dark-gray);
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #777; font-size: 0.7rem; background: none; border: none; text-transform: uppercase; font-weight: bold;
        }
        .nav-item.active { color: var(--accent); background: #252525; }
        .nav-item span { font-size: 1.4rem; margin-bottom: 2px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; padding: 20px; overflow-y: auto; }
        .hp-bar { width: 100%; height: 12px; background: #333; border: 1px solid #555; margin: 8px 0; border-radius: 6px; overflow: hidden; }
        .hp-fill { height: 100%; background: var(--red); transition: width 0.2s; }
        .inv-tabs { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; }
        .inv-tab { background: #222; border: 1px solid #444; color: #888; padding: 6px 12px; font-size: 0.7rem; white-space: nowrap; border-radius: 4px; }
        .inv-tab.active { border-color: var(--accent); color: var(--white); }
        .item-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 8px; }
        .act-btn { background: #333; border: 1px solid #555; color: white; padding: 4px; font-size: 0.65rem; border-radius: 4px; }
        #loading { position: fixed; inset: 0; background: #000; color: white; display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 9999; font-size: 1.2rem; }
    </style>
</head>
<body>
    <div id="loading">
        <h2>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</h2>
        <p>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É</p>
    </div>

    <div id="header-ui">
        <button class="top-btn" onclick="game.showModal('skillsModal')">‚öôÔ∏è –°–ö–ò–õ–õ–´</button>
        <div class="sb-lvl-badge">LVL <span id="sb-lvl">0.00</span></div>
        <button class="top-btn" onclick="game.showModal('leadModal')">üèÜ –¢–û–ü</button>
    </div>

    <div id="viewport">
        <div id="home" class="screen active">
            <div class="card" style="text-align: center;">
                <h1 style="margin:0; color:var(--accent);">üí∞ <span id="coins-val">0</span></h1>
                <small style="color:var(--gray)">–¢–í–û–ò –ú–û–ù–ï–¢–´</small>
            </div>
            <div class="card">
                <div class="stat-grid" id="stats-display"></div>
            </div>
        </div>

        <div id="portal" class="screen">
            <h3 style="text-align:center; margin-top:0;">üåÄ –ü–û–†–¢–ê–õ</h3>
            <div class="portal-grid">
                <div class="portal-node" onclick="game.goLoc('mine')">‚õèÔ∏è –®–ê–•–¢–ê</div>
                <div class="portal-node" onclick="game.goLoc('farm')">üåæ –§–ï–†–ú–ê</div>
                <div class="portal-node" onclick="game.goLoc('fish')">üé£ –†–´–ë–ê–õ–ö–ê</div>
                <div class="portal-node" onclick="game.switchTab('dungeons-menu')">üíÄ –î–ê–ù–ñ–ò</div>
                <div class="portal-node" onclick="game.msg('–°–∫–æ—Ä–æ...')">üëπ –°–õ–ï–ô–ï–†–´</div>
                <div class="portal-node" onclick="game.msg('–°–∫–æ—Ä–æ...')">üõí –ú–ê–ì–ê–ó–ò–ù</div>
                <div class="portal-node" onclick="game.msg('–°–∫–æ—Ä–æ...')">‚öñÔ∏è –û–ë–ú–ï–ù</div>
                <div class="portal-node" onclick="game.msg('–°–∫–æ—Ä–æ...')">üìÖ –ò–í–ï–ù–¢</div>
                <div class="portal-node" onclick="game.msg('–°–∫–æ—Ä–æ...')">üó≥Ô∏è –ú–≠–†</div>
            </div>
        </div>

        <div id="action-loc" class="screen">
            <button class="top-btn" onclick="game.switchTab('portal')">‚Üê –ù–ê–ó–ê–î</button>
            <h2 id="loc-title" style="text-align:center; text-transform:uppercase;">–®–ê–•–¢–ê</h2>
            <div class="card" style="text-align:center">
                <button id="action-btn" class="cooldown-btn" onclick="game.executeAction()">
                    <div id="action-prog" class="progress-overlay"></div>
                    <span style="position:relative">–†–ê–ë–û–¢–ê–¢–¨</span>
                </button>
            </div>
            <div id="loc-log" style="text-align:center; color:var(--green); min-height: 20px; margin-top:10px;"></div>
        </div>

        <div id="dungeons-menu" class="screen">
            <button class="top-btn" onclick="game.switchTab('portal')">‚Üê –ù–ê–ó–ê–î</button>
            <h3>üíÄ –ö–ê–¢–ê–ö–û–ú–ë–´</h3>
            <div class="card">
                <p>–≠–¢–ê–ñ I - –í–•–û–î</p>
                <button class="cooldown-btn" onclick="game.startDungeon()">–í–û–ô–¢–ò –í –î–ê–ù–ñ</button>
            </div>
        </div>

        <div id="battle-screen" class="screen">
            <h2 id="mob-name" style="text-align:center; color:var(--red);">–ú–û–ù–°–¢–†</h2>
            <div class="card">
                <div style="display:flex; justify-content:space-between"><span>–•–ü –í–†–ê–ì–ê</span><span id="m-hp-txt">50/50</span></div>
                <div class="hp-bar"><div id="m-hp-fill" class="hp-fill" style="width:100%"></div></div>
            </div>
            <div class="card" style="border-color:var(--blue)">
                <div style="display:flex; justify-content:space-between"><span>–¢–í–û–Å –•–ü</span><span id="p-hp-txt">100/100</span></div>
                <div class="hp-bar"><div id="p-hp-fill" class="hp-fill" style="width:100%; background:var(--blue)"></div></div>
            </div>
            <button class="cooldown-btn" style="height:80px" onclick="game.dungeonAttack()">üí• –£–î–ê–†–ò–¢–¨</button>
        </div>

        <div id="loot-screen" class="screen">
            <h2 style="text-align:center; color:var(--accent);">–ü–û–ë–ï–î–ê!</h2>
            <p style="text-align:center; font-size:1.2rem;">üéÅ –î–µ—Ä–µ–≤—è–Ω–Ω—ã–π —Å—É–Ω–¥—É–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!</p>
            <button class="cooldown-btn" onclick="game.switchTab('portal')">–í–ï–†–ù–£–¢–¨–°–Ø –ù–ê –ü–û–†–¢–ê–õ</button>
        </div>

        <div id="minions" class="screen">
            <div class="card" style="border-color:var(--accent); text-align:center">
                –ö–û–®–ï–õ–ï–ö: <span id="m-coins-val" style="color:var(--accent)">0</span> üí∞
            </div>
            <div id="minions-list"></div>
        </div>

        <div id="inventory" class="screen">
            <div class="inv-tabs">
                <div class="inv-tab active" onclick="game.filterInv('weapon', this)">–û–†–£–ñ–ò–ï</div>
                <div class="inv-tab" onclick="game.filterInv('armor', this)">–ë–†–û–ù–Ø</div>
                <div class="inv-tab" onclick="game.filterInv('tool', this)">–ò–ù–°–¢–†–£–ú–ï–ù–¢–´</div>
                <div class="inv-tab" onclick="game.filterInv('material', this)">–ú–ê–¢–ï–†–ò–ê–õ</div>
                <div class="inv-tab" onclick="game.filterInv('arrow', this)">–°–¢–†–ï–õ–´</div>
                <div class="inv-tab" onclick="game.filterInv('potion', this)">–ó–ï–õ–¨–Ø</div>
                <div class="inv-tab" onclick="game.filterInv('chest', this)">–°–£–ù–î–£–ö–ò</div>
            </div>
            <div id="inv-list"></div>
        </div>
    </div>

    <div id="skillsModal" class="modal">
        <span style="float:right; font-weight:bold; cursor:pointer" onclick="game.closeModal('skillsModal')">[–ó–ê–ö–†–´–¢–¨]</span>
        <h3>üìä –¢–í–û–ò –ù–ê–í–´–ö–ò</h3>
        <div id="skills-content"></div>
    </div>

    <div id="leadModal" class="modal">
        <span style="float:right; font-weight:bold; cursor:pointer" onclick="game.closeModal('leadModal')">[–ó–ê–ö–†–´–¢–¨]</span>
        <h3>üèÜ –¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</h3>
        <div class="inv-tabs">
            <div class="inv-tab active" id="l-tab-coins" onclick="game.switchLead('coins')">–ü–û –ú–û–ù–ï–¢–ê–ú</div>
            <div class="inv-tab" id="l-tab-lvl" onclick="game.switchLead('lvl')">–ü–û –£–†–û–í–ù–Æ</div>
        </div>
        <div id="lead-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <nav id="nav">
        <button class="nav-item active" onclick="game.switchTab('home', this)"><span>üè†</span>–î–û–ú</button>
        <button class="nav-item" onclick="game.switchTab('portal', this)"><span>üåÄ</span>–ü–û–†–¢–ê–õ</button>
        <button class="nav-item" onclick="game.switchTab('minions', this)"><span>üë∑</span>–ú–ò–ù–¨–û–ù–´</button>
        <button class="nav-item" onclick="game.switchTab('inventory', this)"><span>üéí</span>–ò–ù–í–ï–ù–¢–ê–†–¨</button>
    </nav>

<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";

    const SUPABASE_URL = 'https://acddabgvsbqmaqfvjfst.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjZGRhYmd2c2JxbWFxZnZqZnN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MzA3NDQsImV4cCI6MjA4MjMwNjc0NH0.tKP5nhhZuyPEoySNuQ7ajo6XOkz-cNyZw4kA35OFOFE';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const user = tg.initDataUnsafe?.user;
        const telegramId = user?.id || 123456789;
        const username = user?.username ? "@" + user.username : "–ò–≥—Ä–æ–∫";

        const defaultState = {
            coins: 0,
            nextItemId: 10,
            skills: {
                mining: { lvl: 1, xp: 0, next: 100, label: '–®–ê–•–¢–ê' },
                farming: { lvl: 1, xp: 0, next: 100, label: '–§–ï–†–ú–ê' },
                fishing: { lvl: 1, xp: 0, next: 100, label: '–†–´–ë–ê–õ–ö–ê' },
                combat: { lvl: 1, xp: 0, next: 100, label: '–ë–û–ô' },
                foraging: { lvl: 1, xp: 0, next: 100, label: '–õ–ï–°' }
            },
            stats: { hp: 100, str: 10, def: 0, cc: 5, cd: 50, mf: 0 },
            inventory: [
                { id: 1, name: '–°—Ç–∞—Ä—ã–π –º–µ—á', type: 'weapon', str: 15, equipped: false },
                { id: 2, name: '–ù–∞—á–∞–ª—å–Ω–∞—è –∫–∏—Ä–∫–∞', type: 'tool', equipped: true },
                { id: 3, name: '–ó–µ–ª—å–µ –ª–µ—á–µ–Ω–∏—è', type: 'potion', equipped: false }
            ],
            minions: [
                { id: 'wheat', name: '–ü–®–ï–ù–ò–ß–ù–´–ô', cost: 50, count: 0, stored: 0, rate: 0.5 },
                { id: 'fish', name: '–†–´–ë–ù–´–ô', cost: 75, count: 0, stored: 0, rate: 0.75 },
                { id: 'oak', name: '–î–£–ë–û–í–´–ô', cost: 100, count: 0, stored: 0, rate: 1.0 },
                { id: 'coal', name: '–£–ì–û–õ–¨–ù–´–ô', cost: 125, count: 0, stored: 0, rate: 1.5 }
            ]
        };

        const game = {
            state: { ...defaultState },
            dungeon: { mobIdx: 0, mobHp: 50, pHp: 100, pMaxHp: 100, mobs: ['–ó–û–ú–ë–ò', '–°–ö–ï–õ–ï–¢', '–ü–ê–£–ö', '–ë–û–°–°'] },
            isBusy: false,
            currentLoc: '',
            lastFilter: 'weapon',

            async init() {
                document.getElementById('loading').style.display = 'flex';
                await this.loadFromSupabase();
                this.updateUI();
                setInterval(() => this.minionTick(), 1000);
                setInterval(() => this.saveToSupabase(), 10000);
                document.getElementById('loading').style.display = 'none';
            },

            async loadFromSupabase() {
                const { data, error } = await supabase
                    .from('players')
                    .select('*')
                    .eq('telegram_id', telegramId)
                    .single();

                if (error && error.code === 'PGRST116') {
                    // –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫
                    const { error: insErr } = await supabase.from('players').insert({
                        telegram_id: telegramId,
                        username: username,
                        coins: defaultState.coins,
                        skills: defaultState.skills,
                        inventory: defaultState.inventory,
                        minions: defaultState.minions,
                        next_item_id: defaultState.nextItemId
                    });
                    if (insErr) {
                        console.error(insErr);
                        tg.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç");
                        return;
                    }
                    this.state = { ...defaultState };
                } else if (error) {
                    console.error(error);
                    tg.showAlert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º.");
                } else {
                    this.state.coins = Number(data.coins);
                    this.state.nextItemId = data.next_item_id || 10;
                    this.state.skills = data.skills || defaultState.skills;
                    this.state.inventory = data.inventory || defaultState.inventory;
                    this.state.minions = data.minions || defaultState.minions;
                }
            },

            async saveToSupabase() {
                const { error } = await supabase
                    .from('players')
                    .update({
                        coins: this.state.coins,
                        skills: this.state.skills,
                        inventory: this.state.inventory,
                        minions: this.state.minions,
                        next_item_id: this.state.nextItemId,
                        username: username
                    })
                    .eq('telegram_id', telegramId);

                if (error) console.error("Save error:", error);
            },

            calcStats() {
                let s = { ...this.state.stats };
                this.state.inventory.forEach(i => {
                    if (i.equipped && i.str) s.str += i.str;
                });
                return s;
            },

            updateUI() {
                const s = this.calcStats();
                document.getElementById('coins-val').innerText = Math.floor(this.state.coins).toLocaleString();
                document.getElementById('m-coins-val').innerText = Math.floor(this.state.coins).toLocaleString();

                const totalLvl = Object.values(this.state.skills).reduce((a, b) => a + b.lvl, 0) - 5;
                document.getElementById('sb-lvl').innerText = (totalLvl / 10).toFixed(2);

                document.getElementById('stats-display').innerHTML = `
                    <div><span class="stat-label">‚ù§Ô∏è –ó–î–û–†–û–í–¨–ï:</span> <span class="stat-val">${s.hp}</span></div>
                    <div><span class="stat-label">‚öîÔ∏è –°–ò–õ–ê:</span> <span class="stat-val">${s.str}</span></div>
                    <div><span class="stat-label">üõ°Ô∏è –ë–†–û–ù–Ø:</span> <span class="stat-val">${s.def}</span></div>
                    <div><span class="stat-label">üí• –ö–†–ò–¢ –®–ê–ù–°:</span> <span class="stat-val">${s.cc}%</span></div>
                    <div><span class="stat-label">üî• –ö–†–ò–¢ –£–†–û–ù:</span> <span class="stat-val">${s.cd}%</span></div>
                    <div><span class="stat-label">üçÄ –£–î–ê–ß–ê:</span> <span class="stat-val">${s.mf}</span></div>
                `;

                this.renderMinions();
                this.renderInvList(this.lastFilter);
            },

            goLoc(loc) {
                this.currentLoc = loc;
                this.switchTab('action-loc');
                const titles = { mine: '–®–ê–•–¢–ê', farm: '–§–ï–†–ú–ê', fish: '–†–´–ë–ê–õ–ö–ê' };
                document.getElementById('loc-title').innerText = titles[loc] || '–õ–û–ö–ê–¶–ò–Ø';
                document.getElementById('loc-log').innerText = '';
            },

            executeAction() {
                if (this.isBusy) return;
                this.isBusy = true;
                const prog = document.getElementById('action-prog');
                const btn = document.getElementById('action-btn');
                btn.disabled = true;
                prog.style.width = '0%';
                setTimeout(() => {
                    prog.style.transition = 'width 1.5s linear';
                    prog.style.width = '100%';
                }, 20);

                setTimeout(() => {
                    this.isBusy = false;
                    btn.disabled = false;
                    prog.style.transition = 'none';
                    prog.style.width = '0%';
                    this.finishAction();
                }, 1520);
            },

            async finishAction() {
                const map = { mine: 'mining', farm: 'farming', fish: 'fishing' };
                const skill = this.state.skills[map[this.currentLoc]];
                const gain = 15 * skill.lvl;
                this.state.coins += gain;
                skill.xp += 20;
                if (skill.xp >= skill.next) {
                    skill.lvl++;
                    skill.xp = 0;
                    skill.next *= 1.6;
                    this.msg("LEVEL UP! " + skill.label);
                }
                const materials = { mine: '–£–≥–æ–ª—å', farm: '–ü—à–µ–Ω–∏—Ü–∞', fish: '–†—ã–±–∞' };
                this.addMaterial(materials[this.currentLoc]);

                document.getElementById('loc-log').innerText = `+${gain} üí∞ | +20 XP | +1 ${materials[this.currentLoc]}`;
                this.updateUI();
                await this.saveToSupabase();
                tg.HapticFeedback.impactOccurred('light');
            },

            addMaterial(name, type = 'material') {
                const existing = this.state.inventory.find(i => i.name === name && i.type === type);
                if (existing) {
                    existing.count = (existing.count || 1) + 1;
                } else {
                    this.state.inventory.push({
                        id: this.state.nextItemId++,
                        name: name,
                        type: type,
                        count: 1
                    });
                }
            },

            startDungeon() {
                const s = this.calcStats();
                this.dungeon = {
                    mobIdx: 0,
                    mobHp: 50,
                    pHp: s.hp,
                    pMaxHp: s.hp,
                    mobs: ['–ó–û–ú–ë–ò', '–°–ö–ï–õ–ï–¢', '–ü–ê–£–ö', '–ë–û–°–°']
                };
                this.updateBattleUI();
                this.switchTab('battle-screen');
            },

            async dungeonAttack() {
                const s = this.calcStats();
                let dmg = s.str;
                if (Math.random() * 100 < s.cc) {
                    dmg *= (1 + s.cd / 100);
                    this.msg("–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–î–ê–†!");
                }
                this.dungeon.mobHp -= dmg;

                const enemyDmg = this.dungeon.mobIdx === 3 ? 6 : 4;
                this.dungeon.pHp -= Math.max(1, enemyDmg - s.def);

                if (this.dungeon.mobHp <= 0) {
                    this.dungeon.mobIdx++;
                    if (this.dungeon.mobIdx >= this.dungeon.mobs.length) {
                        await this.giveDungeonReward();
                        this.switchTab('loot-screen');
                    } else {
                        this.dungeon.mobHp = this.dungeon.mobIdx === 3 ? 80 : 50;
                        this.dungeon.pHp = Math.min(this.dungeon.pMaxHp, this.dungeon.pHp + this.dungeon.pMaxHp * 0.2);
                        this.msg("–ú–û–ë –£–ë–ò–¢! +20% –•–ü");
                        this.updateBattleUI();
                    }
                }
                if (this.dungeon.pHp <= 0) {
                    this.msg("–¢–´ –£–ú–ï–†!");
                    this.switchTab('portal');
                } else {
                    this.updateBattleUI();
                }
                tg.HapticFeedback.impactOccurred('medium');
            },

            async giveDungeonReward() {
                this.state.coins += 150;
                this.addMaterial('–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π —Å—É–Ω–¥—É–∫', 'chest');
                this.updateUI();
                await this.saveToSupabase();
            },

            updateBattleUI() {
                document.getElementById('mob-name').innerText = this.dungeon.mobs[this.dungeon.mobIdx] || '???';
                const maxMobHp = this.dungeon.mobIdx === 3 ? 80 : 50;
                document.getElementById('m-hp-txt').innerText = `${Math.max(0, Math.floor(this.dungeon.mobHp))}/${maxMobHp}`;
                document.getElementById('m-hp-fill').style.width = Math.max(0, this.dungeon.mobHp / maxMobHp * 100) + '%';
                document.getElementById('p-hp-txt').innerText = `${Math.max(0, Math.floor(this.dungeon.pHp))}/${this.dungeon.pMaxHp}`;
                document.getElementById('p-hp-fill').style.width = (this.dungeon.pHp / this.dungeon.pMaxHp * 100) + '%';
            },

            renderMinions() {
                const list = document.getElementById('minions-list');
                list.innerHTML = '';
                this.state.minions.forEach((m, i) => {
                    const canBuy = this.state.coins >= m.cost && m.count < 13;
                    const canCollect = m.stored >= 0.1;
                    list.innerHTML += `
                        <div class="card">
                            <div style="display:flex; justify-content:space-between">
                                <b>${m.name} (${m.count}/13)</b>
                                <span>üì¶ ${m.stored.toFixed(1)}/64</span>
                            </div>
                            <div class="item-actions">
                                <button class="act-btn" ${!canBuy ? 'disabled' : ''} onclick="game.buyMinion(${i})">
                                    –ö–£–ü–ò–¢–¨ (${Math.floor(m.cost)}üí∞)
                                </button>
                                <button class="act-btn" ${!canCollect ? 'disabled' : ''} onclick="game.collectMinion(${i})">
                                    –°–û–ë–†–ê–¢–¨ (${Math.floor(m.stored * 20)}üí∞)
                                </button>
                            </div>
                        </div>`;
                });
            },

            async buyMinion(i) {
                const m = this.state.minions[i];
                if (this.state.coins >= m.cost && m.count < 13) {
                    this.state.coins -= m.cost;
                    m.count++;
                    m.cost *= 1.5;
                    m.rate *= 1.2;
                    this.updateUI();
                    await this.saveToSupabase();
                    this.msg("–ú–∏–Ω—å–æ–Ω —É–ª—É—á—à–µ–Ω!");
                }
            },

            async collectMinion(i) {
                const m = this.state.minions[i];
                if (m.stored >= 0.1) {
                    const coinsGain = Math.floor(m.stored * 20);
                    this.state.coins += coinsGain;
                    m.stored = 0;
                    this.updateUI();
                    await this.saveToSupabase();
                    this.msg(`+${coinsGain} üí∞ –æ—Ç –º–∏–Ω—å–æ–Ω–∞!`);
                }
            },

            minionTick() {
                let updated = false;
                this.state.minions.forEach(m => {
                    if (m.count > 0) {
                        const old = m.stored;
                        m.stored = Math.min(64, m.stored + m.rate * m.count / 30);
                        if (Math.floor(m.stored * 10) > Math.floor(old * 10)) updated = true;
                    }
                });
                if (document.querySelector('#minions.active') || updated) {
                    this.renderMinions();
                    document.getElementById('m-coins-val').innerText = Math.floor(this.state.coins).toLocaleString();
                }
            },

            filterInv(type, el) {
                document.querySelectorAll('.inv-tab').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
                this.lastFilter = type;
                this.renderInvList(type);
            },

            renderInvList(type) {
                const list = document.getElementById('inv-list');
                list.innerHTML = '';
                const items = this.state.inventory.filter(i => i.type === type);
                if (items.length === 0) {
                    list.innerHTML = '<div class="card" style="text-align:center; color:#666;">–ü—É—Å—Ç–æ</div>';
                    return;
                }
                items.forEach(item => {
                    const countText = item.count > 1 ? ` (${item.count})` : '';
                    let actions = '';
                    if (item.type === 'material') {
                        actions = `<button class="act-btn" onclick="game.sellItem(${item.id})">–ü–†–û–î–ê–¢–¨</button>`;
                    } else if (item.type === 'chest') {
                        actions = `<button class="act-btn" onclick="game.openChest(${item.id})">–û–¢–ö–†–´–¢–¨</button>`;
                    } else if (['weapon', 'tool', 'armor'].includes(item.type)) {
                        actions = `
                            <button class="act-btn" onclick="game.toggleEquip(${item.id})">
                                ${item.equipped ? '–°–ù–Ø–¢–¨' : '–ù–ê–î–ï–¢–¨'}
                            </button>
                            <button class="act-btn" onclick="game.msg('–£–ª—É—á—à–µ–Ω–æ!')">–£–õ–£–ß–®–ò–¢–¨</button>
                        `;
                    }
                    list.innerHTML += `
                        <div class="card">
                            <b>${item.name}${countText}</b><br>
                            <small>${item.str ? '+' + item.str + ' –°–ò–õ–´' : '–ü–†–ï–î–ú–ï–¢'}</small>
                            <div class="item-actions">${actions}</div>
                        </div>`;
                });
            },

            async openChest(id) {
                const item = this.state.inventory.find(x => x.id === id);
                if (!item || item.type !== 'chest') return;
                const reward = Math.floor(Math.random() * 51) + 50;
                this.state.coins += reward;
                if (item.count > 1) {
                    item.count -= 1;
                } else {
                    this.state.inventory = this.state.inventory.filter(x => x.id !== id);
                }
                this.updateUI();
                await this.saveToSupabase();
                this.msg(`–û—Ç–∫—Ä—ã—Ç —Å—É–Ω–¥—É–∫! +${reward} üí∞`);
            },

            async sellItem(id) {
                const item = this.state.inventory.find(x => x.id === id);
                if (!item || item.type !== 'material') return;
                const sellPrice = 2;
                const count = item.count || 1;
                this.state.coins += sellPrice * count;
                if (count > 1) item.count -= 1;
                else this.state.inventory = this.state.inventory.filter(x => x.id !== id);
                this.updateUI();
                await this.saveToSupabase();
                this.msg(`–ü—Ä–æ–¥–∞–Ω–æ! +${sellPrice * count} üí∞`);
            },

            toggleEquip(id) {
                const item = this.state.inventory.find(x => x.id === id);
                if (!item || !['weapon', 'tool', 'armor'].includes(item.type)) return;
                if (item.type === 'weapon') {
                    this.state.inventory.forEach(x => {
                        if (x.type === 'weapon' && x.id !== id) x.equipped = false;
                    });
                }
                item.equipped = !item.equipped;
                this.updateUI();
                this.saveToSupabase();
            },

            switchTab(id, el) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                if (el) {
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    el.classList.add('active');
                }
            },

            showModal(id) {
                document.getElementById(id).style.display = 'block';
                if (id === 'skillsModal') {
                    let h = '';
                    Object.values(this.state.skills).forEach(s => {
                        const progress = (s.xp / s.next * 100).toFixed(1);
                        h += `
                            <div class="card">
                                <b>${s.label} LVL ${s.lvl}</b><br>
                                <small>${Math.floor(s.xp)} / ${Math.floor(s.next)} XP</small>
                                <div class="hp-bar" style="margin-top:8px;">
                                    <div class="hp-fill" style="width:${progress}%; background:var(--green);"></div>
                                </div>
                            </div>`;
                    });
                    document.getElementById('skills-content').innerHTML = h;
                }
                if (id === 'leadModal') this.switchLead('coins');
            },

            closeModal(id) {
                document.getElementById(id).style.display = 'none';
            },

            async loadLeaderboard(type = 'coins') {
                let orderColumn = type === 'coins' ? 'coins' : null;
                let query = supabase
                    .from('players')
                    .select('username, coins, skills')
                    .order(orderColumn || 'coins', { ascending: false })
                    .limit(10);

                if (!orderColumn) {
                    // –î–ª—è —É—Ä–æ–≤–Ω—è –≤—Ä—É—á–Ω—É—é —Å–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (Supabase –Ω–µ —É–º–µ–µ—Ç –ø–æ —Å—É–º–º–µ json)
                    query = supabase.from('players').select('username, coins, skills');
                }

                const { data, error } = await query;
                if (error) {
                    document.getElementById('lead-list').innerHTML = '<div class="card">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                    return;
                }

                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—é –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
                if (type === 'lvl') {
                    data.sort((a, b) => {
                        const sumA = Object.values(a.skills).reduce((s, v) => s + v.lvl, 0);
                        const sumB = Object.values(b.skills).reduce((s, v) => s + v.lvl, 0);
                        return sumB - sumA;
                    });
                    data.splice(10);
                }

                let html = '';
                data.forEach((p, i) => {
                    let value;
                    if (type === 'coins') value = Math.floor(p.coins).toLocaleString() + ' üí∞';
                    else {
                        const total = Object.values(p.skills).reduce((s, v) => s + v.lvl, 0) - 5;
                        value = (total / 10).toFixed(2);
                    }
                    const name = p.username || '–ò–≥—Ä–æ–∫';
                    html += `<div class="card"><b>${i+1}. ${name}</b><span style="float:right; color:var(--accent)">${value}</span></div>`;
                });

                // –¢–≤–æ—è –ø–æ–∑–∏—Ü–∏—è
                const myValue = type === 'coins' ? Math.floor(this.state.coins) : (() => {
                    const t = Object.values(this.state.skills).reduce((s, v) => s + v.lvl, 0) - 5;
                    return (t / 10).toFixed(2);
                })();
                const myRank = data.findIndex(p => p.username === username) + 1;
                if (myRank > 10 || myRank === 0) {
                    const allPlayers = type === 'coins'
                        ? [...data, { username, coins: this.state.coins }]
                        : data;
                    // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
                    html += `<div class="card" style="border-color:var(--accent)"><b>... ${username} (—Ç—ã)</b><span style="float:right; color:var(--accent)">${myValue}</span></div>`;
                }

                document.getElementById('lead-list').innerHTML = html;
            },

            async switchLead(type) {
                document.querySelectorAll('#leadModal .inv-tab').forEach(b => b.classList.remove('active'));
                document.getElementById('l-tab-' + type).classList.add('active');
                await this.loadLeaderboard(type);
            },

            msg(t) {
                tg.showAlert(t);
            }
        };

        game.init();
    </script>
</body>
</html>
